\section{Entanglement}

  We adopt the convention that alpha-equivalent expressions are interchangeable in all contexts.

  \subsection{Syntax}

    \begin{figure}[H]
      \begin{center}
        \begin{tabular}{l l l}
          $\term \Coloneqq$ & & terms: \\
          & $\eVar$ & variable \\
          & $\eAbs{\eVar}{\type}{\term}$ & term abstraction \\
          & $\eApp{\term}{\term}$ & term application \\
          & $\eTAbs{\tVar}{\kind}{\term}$ & type abstraction \\
          & $\eTApp{\term}{\type}$ & type application \\
          & $\eReify{\tVar}{\term}{\term}$ & reification \\
          & $\eReflect{\tVar}$ & reflection \\
          & $\eDo{\eVar}{\term}{\term}$ & sequence \\
          \\
          $\type, \row \Coloneqq$ & & types: \\
          & $\tVar$ & type variable \\
          & $\tArrow{\type}{\type}$ & arrow type \\
          & $\tForAll{\tVar}{\kind}{\type}$ & universal type \\
          & $\tEntangled{\type}{\row}$ & entangled type \\
          & $\tEmpty$ & empty row \\
          & $\tSingleton{\tVar}$ & singleton row \\
          & $\tUnion{\row}{\row}$ & row union \\
          \\
          $\kind \Coloneqq$ & & kinds: \\
          & $\kType$ & kind of proper types \\
          & $\kRow$ & kind of rows \\
          & $\kWitness{\type}$ & kind of witnesses \\
          \\
          $\context \Coloneqq$ & & contexts: \\
          & $\cEmpty$ & empty context \\
          & $\cEExtend{\context}{\eVar}{\type}$ & term variable binding \\
          & $\cTExtend{\context}{\tVar}{\kind}$ & type variable binding \\
        \end{tabular}
      \end{center}

      \caption{Syntax}
      \label{fig:entanglement_syntax}
    \end{figure}

  \subsection{Typing}

    \begin{figure}[H]
      \begin{center}
        \framebox{$\hasType{\context}{\term}{\type}$}
      \end{center}

      \medskip

      \begin{prooftree}
          \AxiomC{$\apply{\context}{\eVar} = \type$}
        \RightLabel{(\textsc{T-Var})}
        \UnaryInfC{$\hasType{\context}{\eVar}{\type}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\hasType{\cEExtend{\context}{\eVar}{\type_1}}{\term}{\type_2}$}
          \AxiomC{$\hasKind{\context}{\type_1}{\kType}$}
        \RightLabel{(\textsc{T-Abs})}
        \BinaryInfC{$\hasType{\context}{\parens{\eAbs{\eVar}{\type_1}{\term}}}{\tArrow{\type_1}{\type_2}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\hasType{\context}{\term_1}{\tArrow{\type_1}{\type_2}}$}
          \AxiomC{$\hasType{\context}{\term_2}{\type_1}$}
        \RightLabel{(\textsc{T-App})}
        \BinaryInfC{$\hasType{\context}{\eApp{\term_1}{\term_2}}{\type_2}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\hasType{\cTExtend{\context}{\tVar}{\kind}}{\term}{\type}$}
          \AxiomC{$\tVar \notin \dom{\context}$}
        \RightLabel{(\textsc{T-TAbs})}
        \BinaryInfC{$\hasType{\context}{\parens{\eTAbs{\tVar}{\kind}{\term}}}{\parens{\tForAll{\tVar}{\kind}{\type}}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\hasType{\context}{\term}{\parens{\tForAll{\tVar}{\kind}{\type_1}}}$}
          \AxiomC{$\hasKind{\context}{\type_2}{\kind}$}
        \RightLabel{(\textsc{T-TApp})}
        \BinaryInfC{$\hasType{\context}{\eTApp{\term}{\type_2}}{\substitute{\type_1}{\tVar}{\type_2}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{\Shortstack[c]{
            {$\hasType{\context}{\term_1}{\type_1}$ \qquad $\hasType{\cTExtend{\context}{\tVar}{\kWitness{\type_1}}}{\term_2}{\tEntangled{\type_2}{\tUnion{\row}{\tSingleton{\tVar}}}}$}
            {$\hasKind{\context}{\type_2}{\kType}$ \qquad $\hasKind{\context}{\row}{\kRow}$ \qquad $\tVar \notin \dom{\context}$}
          }}
        \RightLabel{(\textsc{T-Reify})}
        \UnaryInfC{$\hasType{\context}{\eReify{\tVar}{\term_1}{\term_2}}{\tEntangled{\type_2}{\row}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\hasKind{\context}{\tVar}{\kWitness{\type}}$}
        \RightLabel{(\textsc{T-Reflect})}
        \UnaryInfC{$\hasType{\context}{\eReflect{\tVar}}{\tEntangled{\type}{\tSingleton{\tVar}}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\hasType{\context}{\term_1}{\tEntangled{\type_1}{\row}}$}
          \AxiomC{$\hasType{\cEExtend{\context}{\eVar}{\type_1}}{\term_2}{\tEntangled{\type_2}{\row}}$}
        \RightLabel{(\textsc{T-Do})}
        \BinaryInfC{$\hasType{\context}{\eDo{\eVar}{\term_1}{\term_2}}{\tEntangled{\type_2}{\row}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\hasType{\context}{\term}{\type}$}
          \AxiomC{$\hasKind{\context}{\row}{\kRow}$}
        \RightLabel{(\textsc{T-Entangle})}
        \BinaryInfC{$\hasType{\context}{\term}{\tEntangled{\type}{\row}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\hasType{\context}{\term}{\tEntangled{\type}{\tEmpty}}$}
        \RightLabel{(\textsc{T-Escape})}
        \UnaryInfC{$\hasType{\context}{\term}{\type}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\hasType{\context}{\term}{\tEntangled{\type}{\row_1}}$}
          \AxiomC{$\rowSub{\context}{\row_1}{\row_2}$}
        \RightLabel{(\textsc{T-Subsumption})}
        \BinaryInfC{$\hasType{\context}{\term}{\tEntangled{\type}{\row_2}}$}
      \end{prooftree}

      \caption{Typing rules}
      \label{fig:entanglement_typing}
    \end{figure}

    \begin{figure}[H]
      \begin{center}
        \framebox{$\hasKind{\context}{\type}{\kind}$}
      \end{center}

      \medskip

      \begin{prooftree}
          \AxiomC{$\apply{\context}{\tVar} = \kind$}
        \RightLabel{(\textsc{K-Var})}
        \UnaryInfC{$\hasKind{\context}{\tVar}{\kind}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\hasKind{\context}{\type_1}{\kType}$}
          \AxiomC{$\hasKind{\context}{\type_2}{\kType}$}
        \RightLabel{(\textsc{K-Arrow})}
        \BinaryInfC{$\hasKind{\context}{\tArrow{\type_1}{\type_2}}{\kType}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\hasKind{\cTExtend{\context}{\tVar}{\kind}}{\type}{\kType}$}
        \RightLabel{(\textsc{K-ForAll})}
        \UnaryInfC{$\hasKind{\context}{\parens{\tForAll{\tVar}{\kind}{\type}}}{\kType}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\hasKind{\context}{\type}{\kType}$}
          \AxiomC{$\hasKind{\context}{\row}{\kRow}$}
        \RightLabel{(\textsc{K-Entangled})}
        \BinaryInfC{$\hasKind{\context}{\tEntangled{\type}{\row}}{\kType}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{}
        \RightLabel{(\textsc{K-Empty})}
        \UnaryInfC{$\hasKind{\context}{\tEmpty}{\kRow}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\hasKind{\context}{\tVar}{\kWitness{\type}}$}
        \RightLabel{(\textsc{K-Singleton})}
        \UnaryInfC{$\hasKind{\context}{\tSingleton{\tVar}}{\kRow}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\hasKind{\context}{\row_1}{\kRow}$}
          \AxiomC{$\hasKind{\context}{\row_2}{\kRow}$}
        \RightLabel{(\textsc{K-Union})}
        \BinaryInfC{$\hasKind{\context}{\tUnion{\row_1}{\row_2}}{\kRow}$}
      \end{prooftree}

      \caption{Kinding rules}
      \label{fig:entanglement_kinding}
    \end{figure}

    \begin{figure}[H]
      \begin{center}
        \framebox{$\rowSub{\context}{\row}{\row}$}
      \end{center}

      \medskip

      \begin{prooftree}
          \AxiomC{$\hasKind{\context}{\row}{\kRow}$}
        \RightLabel{(\textsc{R-Refl})}
        \UnaryInfC{$\rowSub{\context}{\row}{\row}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\hasKind{\context}{\row}{\kRow}$}
        \RightLabel{(\textsc{R-Empty})}
        \UnaryInfC{$\rowSub{\context}{\tEmpty}{\row}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\rowSub{\context}{\row_1}{\row_2}$}
          \AxiomC{$\hasKind{\context}{\row_3}{\kRow}$}
        \RightLabel{(\textsc{R-Weakening1})}
        \BinaryInfC{$\rowSub{\context}{\row_1}{\tUnion{\row_2}{\row_3}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\rowSub{\context}{\row_1}{\row_3}$}
          \AxiomC{$\hasKind{\context}{\row_2}{\kRow}$}
        \RightLabel{(\textsc{R-Weakening2})}
        \BinaryInfC{$\rowSub{\context}{\row_1}{\tUnion{\row_2}{\row_3}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\rowSub{\context}{\row_1}{\row_3}$}
          \AxiomC{$\rowSub{\context}{\row_2}{\row_3}$}
        \RightLabel{(\textsc{R-Strengthening})}
        \BinaryInfC{$\rowSub{\context}{\tUnion{\row_1}{\row_2}}{\row_3}$}
      \end{prooftree}

      \caption{Row subsumption}
      \label{fig:row_subsumption}
    \end{figure}

  \subsection{Semantics}

    \begin{figure}[H]
      \ifnoacm
        \small
      \fi

      \begin{center}
        \framebox{$\translatesTo{\context}{\term}{\term}$}
        \framebox{$\translatesTo{\context}{\type}{\type}$}
        \framebox{$\translatesTo{\context}{\type}{\term}$}
      \end{center}

      \medskip

      \begin{prooftree}
          \AxiomC{}
        \RightLabel{(\textsc{S-Var})}
        \UnaryInfC{$\translatesTo{\context}{\eVar}{\eVar}$}
      \end{prooftree}

      \begin{center}
          \AxiomC{$\hasKind{\context}{\tVar}{\kType}$}
        \RightLabel{(\textsc{S-TVar1})}
        \UnaryInfC{$\translatesTo{\context}{\tVar}{\tVar}$}
        \DisplayProof
        \qquad
          \AxiomC{$\hasKind{\context}{\tVar}{\kRow}$}
        \RightLabel{(\textsc{S-TVar2})}
        \UnaryInfC{$\translatesTo{\context}{\tVar}{\tVoid}$}
        \DisplayProof
        \qquad
          \AxiomC{$\hasKind{\context}{\tVar}{\kWitness{\type}}$}
        \RightLabel{(\textsc{S-TVar3})}
        \UnaryInfC{$\translatesTo{\context}{\tVar}{\eVar_{\tVar}}$}
        \DisplayProof
      \end{center}

      \begin{center}
          \AxiomC{$\translatesTo{\context}{\type_1}{\type_2}$}
          \AxiomC{$\translatesTo{\context}{\term_1}{\term_2}$}
        \RightLabel{(\textsc{S-Abs1})}
        \BinaryInfC{$\translatesTo{\context}{\eAbs{\eVar}{\type_1}{\term_1}}{\eAbs{\eVar}{\type_2}{\term_2}}$}
        \DisplayProof
        \qquad
          \AxiomC{$\translatesTo{\context}{\type}{\term_3}$}
          \AxiomC{$\translatesTo{\context}{\term_1}{\term_2}$}
        \RightLabel{(\textsc{S-Abs2})}
        \BinaryInfC{$\translatesTo{\context}{\eAbs{\eVar}{\type}{\term_1}}{\eAbs{\eVar}{\tVoid}{\term_2}}$}
        \DisplayProof
      \end{center}

      \begin{center}
          \AxiomC{$\translatesTo{\context}{\term_1}{\term_3}$}
          \AxiomC{$\translatesTo{\context}{\term_2}{\term_4}$}
        \RightLabel{(\textsc{S-App})}
        \BinaryInfC{$\translatesTo{\context}{\eApp{\term_1}{\term_2}}{\eApp{\term_3}{\term_4}}$}
        \DisplayProof
        \qquad
          \AxiomC{$\translatesTo{\context}{\term_1}{\term_2}$}
        \RightLabel{(\textsc{S-TAbs1})}
        \UnaryInfC{$\translatesTo{\context}{\eTAbs{\tVar}{\kType}{\term_1}}{\eTAbsNoKind{\tVar}{\term_2}}$}
        \DisplayProof
      \end{center}

      \begin{center}
          \AxiomC{$\translatesTo{\context}{\type_1}{\type_2}$}
          \AxiomC{$\translatesTo{\context}{\term_1}{\term_2}$}
        \RightLabel{(\textsc{S-TAbs2})}
        \BinaryInfC{$\translatesTo{\context}{\eTAbs{\tVar}{\kWitness{\type_1}}{\term_1}}{\eAbs{\eVar_{\tVar}}{\type_2}{\term_2}}$}
        \DisplayProof
        \qquad
          \AxiomC{$\translatesTo{\context}{\type}{\term_3}$}
          \AxiomC{$\translatesTo{\context}{\term_1}{\term_2}$}
        \RightLabel{(\textsc{S-TAbs3})}
        \BinaryInfC{$\translatesTo{\context}{\eTAbs{\tVar}{\kWitness{\type}}{\term_1}}{\eAbs{\eVar_{\tVar}}{\tVoid}{\term_2}}$}
        \DisplayProof
      \end{center}

      \begin{center}
          \AxiomC{$\translatesTo{\context}{\term_1}{\term_2}$}
          \AxiomC{$\translatesTo{\context}{\type_1}{\type_2}$}
        \RightLabel{(\textsc{S-TApp1})}
        \BinaryInfC{$\translatesTo{\context}{\eTApp{\term_1}{\type_1}}{\eTApp{\term_2}{\type_2}}$}
        \DisplayProof
        \qquad
          \AxiomC{$\translatesTo{\context}{\term_1}{\term_2}$}
          \AxiomC{$\translatesTo{\context}{\type}{\term_3}$}
        \RightLabel{(\textsc{S-TApp2})}
        \BinaryInfC{$\translatesTo{\context}{\eTApp{\term_1}{\type}}{\eApp{\term_2}{\term_3}}$}
        \DisplayProof
      \end{center}

      \begin{center}
          \AxiomC{$\translatesTo{\context}{\term_1}{\term_3}$}
          \AxiomC{$\translatesTo{\context}{\term_2}{\term_4}$}
        \RightLabel{(\textsc{S-Reify})}
        \BinaryInfC{$\translatesTo{\context}{\eReify{\tVar}{\term_1}{\term_2}}{\substitute{\term_4}{\eVar_{\tVar}}{\term_3}}$}
        \DisplayProof
        \qquad
          \AxiomC{}
        \RightLabel{(\textsc{S-Reflect})}
        \UnaryInfC{$\translatesTo{\context}{\eReflect{\tVar}}{\eVar_{\tVar}}$}
        \DisplayProof
      \end{center}

      \begin{center}
          \AxiomC{$\translatesTo{\context}{\term_1}{\term_3}$}
          \AxiomC{$\translatesTo{\context}{\term_2}{\term_4}$}
        \RightLabel{(\textsc{S-Do})}
        \BinaryInfC{$\translatesTo{\context}{\eDo{\eVar}{\term_1}{\term_2}}{\substitute{\term_4}{\eVar}{\term_3}}$}
        \DisplayProof
        \qquad
          \AxiomC{$\translatesTo{\context}{\type_1}{\type_2}$}
        \RightLabel{(\textsc{S-Entangled})}
        \UnaryInfC{$\translatesTo{\context}{\tEntangled{\type_1}{\row}}{\type_2}$}
        \DisplayProof
      \end{center}

      \begin{center}
          \AxiomC{$\translatesTo{\context}{\type_1}{\type_3}$}
          \AxiomC{$\translatesTo{\context}{\type_2}{\type_4}$}
        \RightLabel{(\textsc{S-Arrow1})}
        \BinaryInfC{$\translatesTo{\context}{\tArrow{\type_1}{\type_2}}{\tArrow{\type_3}{\type_4}}$}
        \DisplayProof
        \qquad
          \AxiomC{$\translatesTo{\context}{\type_1}{\type_3}$}
          \AxiomC{$\translatesTo{\context}{\type_2}{\term}$}
        \RightLabel{(\textsc{S-Arrow2})}
        \BinaryInfC{$\translatesTo{\context}{\tArrow{\type_1}{\type_2}}{\tArrow{\type_3}{\tVoid}}$}
        \DisplayProof
      \end{center}

      \begin{center}
          \AxiomC{$\translatesTo{\context}{\type_1}{\term}$}
          \AxiomC{$\translatesTo{\context}{\type_2}{\type_3}$}
        \RightLabel{(\textsc{S-Arrow3})}
        \BinaryInfC{$\translatesTo{\context}{\tArrow{\type_1}{\type_2}}{\tArrow{\tVoid}{\type_3}}$}
        \DisplayProof
        \qquad
          \AxiomC{$\translatesTo{\context}{\type_1}{\term_1}$}
          \AxiomC{$\translatesTo{\context}{\type_2}{\term_2}$}
        \RightLabel{(\textsc{S-Arrow4})}
        \BinaryInfC{$\translatesTo{\context}{\tArrow{\type_1}{\type_2}}{\tArrow{\tVoid}{\tVoid}}$}
        \DisplayProof
      \end{center}

      \begin{center}
          \AxiomC{$\translatesTo{\context}{\type_1}{\type_2}$}
        \RightLabel{(\textsc{S-ForAll1})}
        \UnaryInfC{$\translatesTo{\context}{\tForAll{\tVar}{\kType}{\type_1}}{\tForAllNoKind{\tVar}{\type_2}}$}
        \DisplayProof
        \qquad
          \AxiomC{$\translatesTo{\context}{\type}{\term}$}
        \RightLabel{(\textsc{S-ForAll2})}
        \UnaryInfC{$\translatesTo{\context}{\tForAll{\tVar}{\kType}{\type}}{\tForAllNoKind{\tVar}{\tVoid}}$}
        \DisplayProof
      \end{center}

      \begin{center}
          \AxiomC{$\translatesTo{\context}{\type_1}{\type_3}$}
          \AxiomC{$\translatesTo{\context}{\type_2}{\type_4}$}
        \RightLabel{(\textsc{S-ForAll3})}
        \BinaryInfC{$\translatesTo{\context}{\tForAll{\tVar}{\kWitness{\type_1}}{\type_2}}{\tArrow{\type_3}{\type_4}}$}
        \DisplayProof
        \qquad
          \AxiomC{$\translatesTo{\context}{\type_1}{\type_3}$}
          \AxiomC{$\translatesTo{\context}{\type_2}{\term}$}
        \RightLabel{(\textsc{S-ForAll4})}
        \BinaryInfC{$\translatesTo{\context}{\tForAll{\tVar}{\kWitness{\type_1}}{\type_2}}{\tArrow{\type_3}{\tVoid}}$}
        \DisplayProof
      \end{center}

      \begin{center}
          \AxiomC{$\translatesTo{\context}{\type_1}{\term}$}
          \AxiomC{$\translatesTo{\context}{\type_2}{\type_3}$}
        \RightLabel{(\textsc{S-ForAll5})}
        \BinaryInfC{$\translatesTo{\context}{\tForAll{\tVar}{\kWitness{\type_1}}{\type_2}}{\tArrow{\tVoid}{\type_3}}$}
        \DisplayProof
        \qquad
          \AxiomC{$\translatesTo{\context}{\type_1}{\term_1}$}
          \AxiomC{$\translatesTo{\context}{\type_2}{\term_2}$}
        \RightLabel{(\textsc{S-ForAll6})}
        \BinaryInfC{$\translatesTo{\context}{\tForAll{\tVar}{\kWitness{\type_1}}{\type_2}}{\tArrow{\tVoid}{\tVoid}}$}
        \DisplayProof
      \end{center}

      \begin{center}
          \AxiomC{}
        \RightLabel{(\textsc{S-Empty})}
        \UnaryInfC{$\translatesTo{\context}{\tEmpty}{\tVoid}$}
        \DisplayProof
        \qquad
          \AxiomC{}
        \RightLabel{(\textsc{S-Singleton})}
        \UnaryInfC{$\translatesTo{\context}{\tSingleton{\tVar}}{\tVoid}$}
        \DisplayProof
        \qquad
          \AxiomC{}
        \RightLabel{(\textsc{S-Union})}
        \UnaryInfC{$\translatesTo{\context}{\tUnion{\row_1}{\row_2}}{\tVoid}$}
        \DisplayProof
      \end{center}

      \caption{Translation into System F}
      \label{fig:entanglement_semantics}
    \end{figure}
