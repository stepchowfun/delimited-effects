%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Document settings and packages %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\documentclass[12pt]{article}

\usepackage[T1]{fontenc} % The font encoding
\usepackage[framemethod=tikz]{mdframed} % For figures (`tikz` allows us to have a transparent background)
\usepackage[margin=1in]{geometry} % For setting the margin
\usepackage{amssymb} % For \varnothing
\usepackage{bussproofs} % For inference rules
\usepackage{float} % For the [H] option in \begin{figure}[H]. NOTE: Stop using this when we have more content
\usepackage{inconsolata} % Monospace font
\usepackage{listings} % For source code
\usepackage{mathtools} % For \Coloneqq
\usepackage{stackengine} % For stacking axioms
\usepackage{stmaryrd} % For \llbracket and \rrbracket

% Add a "Draft" watermark to the background.
\usepackage{draftwatermark}
\SetWatermarkText{\textsc{Draft}}
\SetWatermarkScale{3}
\SetWatermarkLightness{0.975}

\title{Delimited effects}
\date{}

%%%%%%%%%%%%%%%%%%%%%%%%%%
% Source code formatting %
%%%%%%%%%%%%%%%%%%%%%%%%%%

\definecolor{purple}{RGB}{127, 0, 181}

\lstdefinelanguage{gram}{morekeywords={effect, handle}}

\lstset{
  aboveskip=\bigskipamount,
  basicstyle=\ttfamily,
  belowskip=\bigskipamount,
  keepspaces=true,
  keywordstyle=\bfseries\color{purple},
  language=gram,
}

%%%%%%%%%%
% Macros %
%%%%%%%%%%

% Theorem styles
\newtheorem{definition}{Definition}
\newtheorem{theorem}{Theorem}

% Misc
\newcommand\anno[2]{#1 : #2}
\newcommand\apply[2]{#1\parens{#2}}
\newcommand\parens[1]{\left( #1 \right)}
\newcommand\substitute[3]{#1 \left[ #3 / #2 \right]}
\newcommand\dom[1]{\apply{\text{dom}}{#1}}

% Effects and handlers
\newcommand\xVar{\varepsilon}
\newcommand\hVar{\phi}
\newcommand\hToX[2]{#1 \mapsto #2}

% Rows
\newcommand\row{\Delta}
\newcommand\rEmpty{\varnothing}
\newcommand\rExtend[3]{#1, \hToX{#2}{#3}}

% Terms
\newcommand\term{t}
\newcommand\eVar{x}
\newcommand\eAbs[3]{\lambda \anno{#1}{#2} \; . \; #3}
\newcommand\eApp[2]{#1 \; #2}
\newcommand\eTAbs[2]{\lambda #1 \; . \; #2}
\newcommand\eTApp[2]{#1 \; #2}
\newcommand\eHAbs[2]{\lambda #1 \; . \; #2}
\newcommand\eHApp[2]{#1 \; #2}
\newcommand\eSuspend[2]{\textbf{suspend} \; #1 \; \textbf{with} \; #2}
\newcommand\eDo[1]{\textbf{do} \; #1}
\newcommand\eEffect[4]{\textbf{effect} \; #1 \; \textbf{where} \; \anno{#2}{#3} \; \textbf{in} \; #4}
\newcommand\eHandle[4]{\textbf{handle} \; \hToX{#1}{#2} \; \textbf{with} \; #3 \; \textbf{in} \; #4}

% Types
\newcommand\type{\tau}
\newcommand\tVar{\alpha}
\newcommand\tArrow[2]{#1 \rightarrow #2}
\newcommand\tTForAll[2]{\forall #1 \; . \; #2}
\newcommand\tHForAll[2]{\forall #1 \; . \; #2}
\newcommand\tComputation[2]{#1 \; ! \; #2}

% Contexts
\newcommand\context{\Gamma}
\newcommand\cEmpty{\varnothing}
\newcommand\cEExtend[3]{#1, \anno{#2}{#3}}
\newcommand\cTExtend[2]{#1, #2}
\newcommand\cXExtend[3]{#1, #2 \mapsto #3}
\newcommand\cHExtend[2]{#1, #2}

% Judgments
\newcommand\rSub[2]{#1 \subseteq #2}
\newcommand\hasType[4]{#1; #2 \vdash \anno{#3}{#4}}

%%%%%%%%%%%%%%%%%%%%%
% The specification %
%%%%%%%%%%%%%%%%%%%%%

\begin{document}
  \maketitle

  \begin{abstract}
    We introduce delimited effects, a modest type and effect system capable of modeling a diverse collection of programming language features including algebraic effects, type classes with local instances, and dynamic scoping.
  \end{abstract}

  \section{Introduction}

    \iffalse
      \begin{lstlisting}[gobble=4]
        effect IO
          getLine   : String ! IO
          printLine : String -> () ! IO
      \end{lstlisting}

      \begin{lstlisting}[gobble=4]
        effect Monoid a
          mempty  : a ! Monoid a
          mappend : a -> a -> a ! Monoid a
      \end{lstlisting}
    \fi

  \section{Overview}

    We adopt the convention that alpha-equivalent terms and types are interchangeable in all contexts.

    \subsection{Syntax}

      \begin{figure}[H]
        \begin{mdframed}[backgroundcolor=none]
          \begin{center}
            \begin{tabular}{l l l}
              $\term \Coloneqq$ & & terms: \\
              & $\eVar$ & variable \\
              & $\eAbs{\eVar}{\type}{\term}$ & abstraction \\
              & $\eApp{\term}{\term}$ & application \\
              & $\eTAbs{\tVar}{\term}$ & type abstraction \\
              & $\eTApp{\term}{\type}$ & type application \\
              & $\eHAbs{\hVar}{\term}$ & handler abstraction \\
              & $\eHApp{\term}{\hVar}$ & handler application \\
              & $\eSuspend{\term}{\row}$ & computation introduction \\
              & $\eDo{\term}$ & computation elimination \\
              & $\eEffect{\xVar}{\eVar}{\type}{\term}$ & effect definition \\
              & $\eHandle{\hVar}{\xVar}{\term}{\term}$ & effect handler \\
              \\
              $\type \Coloneqq$ & & types: \\
              & $\tVar$ & type variable \\
              & $\tArrow{\type}{\type}$ & arrow type \\
              & $\tTForAll{\tVar}{\type}$ & quantification over types \\
              & $\tHForAll{\hVar}{\type}$ & quantification over handlers \\
              & $\tComputation{\type}{\row}$ & computation type \\
              \\
              $\row \Coloneqq$ & & rows: \\
              & $\rEmpty$ & empty row \\
              & $\rExtend{\row}{\hVar}{\xVar}$ & row extension \\
              \\
              $\context \Coloneqq$ & & contexts: \\
              & $\cEmpty$ & empty context \\
              & $\cEExtend{\context}{\eVar}{\type}$ & variable binding \\
              & $\cTExtend{\context}{\tVar}$ & type variable binding \\
              & $\cXExtend{\context}{\xVar}{\type}$ & effect variable binding \\
              & $\cHExtend{\context}{\hVar}$ & handler variable binding \\
            \end{tabular}
          \end{center}

          \caption{Syntax}\label{fig:syntax}
        \end{mdframed}
      \end{figure}

    \subsection{Typing}

      \begin{figure}[H]
        \begin{mdframed}[backgroundcolor=none]
          \begin{center}
            \framebox{$\hasType{\context}{\row}{\term}{\type}$}
          \end{center}

          \medskip

          \begin{prooftree}
              \AxiomC{$\type = \apply{\context}{\eVar}$}
            \RightLabel{(\textsc{T-Var})}
            \UnaryInfC{$\hasType{\context}{\row}{\eVar}{\type}$}
          \end{prooftree}

          \begin{prooftree}
              \AxiomC{$\hasType{\cEExtend{\context}{\eVar}{\type_1}}{\rEmpty}{\term}{\type_2}$}
            \RightLabel{(\textsc{T-Abs})}
            \UnaryInfC{$\hasType{\context}{\row}{\eAbs{\eVar}{\type_1}{\term}}{\tArrow{\type_1}{\type_2}}$}
          \end{prooftree}

          \begin{prooftree}
              \AxiomC{$\hasType{\context}{\row}{\term_1}{\type_1}$}
              \AxiomC{$\hasType{\context}{\row}{\term_2}{\tArrow{\type_1}{\type_2}}$}
            \RightLabel{(\textsc{T-App})}
            \BinaryInfC{$\hasType{\context}{\row}{\eApp{\term_2}{\term_1}}{\type_2}$}
          \end{prooftree}

          \begin{prooftree}
              \AxiomC{$\hasType{\cTExtend{\context}{\tVar}}{\row}{\term}{\type}$}
              \AxiomC{$\tVar \notin \dom{\context}$}
            \RightLabel{(\textsc{T-TAbs})}
            \BinaryInfC{$\hasType{\context}{\row}{\eTAbs{\tVar}{\term}}{\tTForAll{\tVar}{\type}}$}
          \end{prooftree}

          \begin{prooftree}
              \AxiomC{$\hasType{\context}{\row}{\term}{\tTForAll{\tVar}{\type_1}}$}
            \RightLabel{(\textsc{T-TApp})}
            \UnaryInfC{$\hasType{\context}{\row}{\eTApp{\term}{\type_2}}{\substitute{\type_1}{\tVar}{\type_2}}$}
          \end{prooftree}

          \begin{prooftree}
              \AxiomC{$\hasType{\cTExtend{\context}{\hVar}}{\row}{\term}{\type}$}
              \AxiomC{$\hVar \notin \dom{\context}$}
            \RightLabel{(\textsc{T-HAbs})}
            \BinaryInfC{$\hasType{\context}{\row}{\eHAbs{\hVar}{\term}}{\tHForAll{\hVar}{\type}}$}
          \end{prooftree}

          \begin{prooftree}
              \AxiomC{$\hasType{\context}{\row}{\term}{\tHForAll{\hVar_1}{\type}}$}
            \RightLabel{(\textsc{T-HApp})}
            \UnaryInfC{$\hasType{\context}{\row}{\eHApp{\term}{\hVar_2}}{\substitute{\type}{\hVar_1}{\hVar_2}}$}
          \end{prooftree}

          \begin{prooftree}
              \AxiomC{$\hasType{\context}{\row_2}{\term}{\type}$}
            \RightLabel{(\textsc{T-Suspend})}
            \UnaryInfC{$\hasType{\context}{\row_1}{\eSuspend{\term}{\row_2}}{\tComputation{\type}{\row_2}}$}
          \end{prooftree}

          \begin{prooftree}
              \AxiomC{$\hasType{\context}{\row_1}{\term}{\tComputation{\type}{\row_2}}$}
              \AxiomC{$\rSub{\row_2}{\row_1}$}
            \RightLabel{(\textsc{T-Do})}
            \BinaryInfC{$\hasType{\context}{\row_1}{\eDo{\term}}{\type}$}
          \end{prooftree}

          \begin{prooftree}
              \AxiomC{$\hasType{\cEExtend{\cXExtend{\context}{\xVar}{\type_1}}{\eVar}{\tHForAll{\hVar}{\tComputation{\type_1}{\rExtend{\rEmpty}{\hVar}{\xVar}}}}}{\row}{\term}{\type_2}$}
              \AxiomC{$\xVar \notin \dom{\context}$}
            \RightLabel{(\textsc{T-Effect})}
            \BinaryInfC{$\hasType{\context}{\row}{\eEffect{\xVar}{\eVar}{\type_1}{\term}}{\type_2}$}
          \end{prooftree}

          \begin{prooftree}
              \AxiomC{$\hasType{\cHExtend{\context}{\hVar}}{\rExtend{\row}{\hVar}{\xVar}}{\term_2}{\type_2}$}
              \AxiomC{$\hasType{\context}{\row}{\term_1}{\type_1}$}
              \AxiomC{$\type_1 = \apply{\context}{\xVar}$}
              \AxiomC{$\hVar \notin \dom{\context}$}
            \RightLabel{(\textsc{T-Handle})}
            \QuaternaryInfC{$\hasType{\context}{\row}{\eHandle{\hVar}{\xVar}{\term_1}{\term_2}}{\type_2}$}
          \end{prooftree}

          \caption{Typing rules}\label{fig:typing}
        \end{mdframed}
      \end{figure}

\end{document}
