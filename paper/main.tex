%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Document settings and packages %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\documentclass[12pt]{article}

\usepackage[framemethod=tikz]{mdframed} % For figures (`tikz` allows us to have a transparent background)
\usepackage[margin=1in]{geometry} % For setting the margin
\usepackage{amssymb} % For \varnothing
\usepackage{bussproofs} % For inference rules
\usepackage{listings} % For source code
\usepackage{mathtools} % For \Coloneqq
\usepackage{stackengine} % For stacking axioms
\usepackage{stmaryrd} % For \llbracket and \rrbracket
\usepackage{inconsolata} % Monospace font
\usepackage[T1]{fontenc} % The font encoding

% Add a "Draft" watermark to the background.
\usepackage{draftwatermark}
\SetWatermarkText{\textsc{Draft}}
\SetWatermarkScale{3}
\SetWatermarkLightness{0.975}

\title{Delimited effects}
\date{}

%%%%%%%%%%%%%%%%%%%%%%%%%%
% Source code formatting %
%%%%%%%%%%%%%%%%%%%%%%%%%%

\definecolor{purple}{RGB}{127, 0, 181}

\lstdefinelanguage{gram}{morekeywords={effect, provide}}

\lstset{
  aboveskip=\bigskipamount,
  basicstyle=\ttfamily,
  belowskip=\bigskipamount,
  keepspaces=true,
  keywordstyle=\bfseries\color{purple},
  language=gram,
}

%%%%%%%%%%
% Macros %
%%%%%%%%%%

% Theorem styles
\newtheorem{definition}{Definition}
\newtheorem{theorem}{Theorem}

% Misc
\newcommand\anno[2]{#1 : #2}
\newcommand\dom[1]{\text{dom}\parens{#1}}
\newcommand\freevars[1]{\text{free}\parens{#1}}
\newcommand\lookup[2]{#1\parens{#2}}
\newcommand\lstof[1]{\overline{#1}}
\newcommand\parens[1]{\left( #1 \right)}
\newcommand\sub[3]{#1 \left[ #2 \mapsto #3 \right]}

% Terms
\newcommand\term{t}
\newcommand\eunit{()}
\newcommand\evar{x}
\newcommand\eabs[2]{\lambda #1 \; . \; #2}
\newcommand\eapp[2]{#1 \; #2}
\newcommand\etabs[2]{\lambda #1 \; . \; #2}
\newcommand\etapp[2]{#1 \; #2}
\newcommand\eprovide[4]{\textbf{provide} \; #1 \; \textbf{with} \; #2 = #3 \; \textbf{in} \; #4}

% Types
\newcommand\type{\tau}
\newcommand\tvar{\alpha}
\newcommand\twitht[2]{#1 \; ! \; #2}
\newcommand\tunit{1}
\newcommand\tarrow[2]{#1 \rightarrow #2}
\newcommand\tforall[2]{\forall #1 \; . \; #2}
\newcommand\teffect[3]{\mu #1 \; . \; \left\langle\anno{#2}{#3}\right\rangle}

% Effect rows
\newcommand\effect{\varepsilon}
\newcommand\rempty{\varnothing_{\type}}
\newcommand\rsingleton[1]{\left\{ #1 \right\}}
\newcommand\runion[2]{#1, #2}
\newcommand\rdiff[2]{#1 \; - \; #2}

% Kinds
\newcommand\kind{\kappa}
\newcommand\kpt{$\tiny $\square}
\newcommand\krow{\diamond}
\newcommand\ktwitht{\ast}

% Type contexts
\newcommand\context{\Gamma}
\newcommand\cempty{\varnothing_{\context}}
\newcommand\cextend[2]{#1, #2}

% Effect map
\newcommand\effectmap{\Delta}
\newcommand\emempty{\varnothing_{\effectmap}}
\newcommand\emmap[2]{#1 \mapsto #2}
\newcommand\emextend[2]{#1, #2}

% Judgements
\newcommand\tjudgment[3]{#1 \vdash \anno{#2}{#3}}
\newcommand\opwellformed[3]{#1 \vdash #2 \; \triangleright \; #3}
\newcommand\subtype[3]{#1 \vdash #2 \; \sqsubseteq \; #3}

%%%%%%%%%%%%%%%%%%%%%
% The specification %
%%%%%%%%%%%%%%%%%%%%%

\begin{document}
  \maketitle

  \begin{abstract}
    We introduce delimited effects, a modest type and effect system capable of modeling a diverse collection of programming language features including algebraic effects, type classes, and dynamic scoping.
  \end{abstract}

  \section{Introduction}

  The system we describe in this paper is motivated by the observation that a variety of seemingly orthogonal ideas in programming languages are variations on a common theme: tracking predicates in the type system without requiring the explicit threading of witnesses through the program at the term level. A sufficiently smart inference algorithm frees the programmer from the ceremony of annotating types and propagating predicates. There's no shortage of examples of this theme: type classes, implicit parameters, algebraic effects, etc. In this paper, we generalize these ideas by a single language construct, which we call \emph{delimited effects}.

  Our primary contributions are:

  \begin{itemize}
    \item We give the syntax, semantics, and typing rules for our system.
    \item We prove that the typing rules are sound with respect to the semantics.
    \item We provide one of many possible type inference algorithms for the system.
    \item We provide several diverse examples of programming language features which are generalized by our system.
  \end{itemize}

  \section{Overview}

  \begin{lstlisting}[gobble=4]
    effect IO
      getLine   : String ! IO
      printLine : String -> () ! IO
  \end{lstlisting}

  \begin{lstlisting}[gobble=4]
    effect Monoid a
      mempty  : a ! Monoid a
      mappend : a -> a -> a ! Monoid a
  \end{lstlisting}

  \begin{figure}
    \begin{mdframed}[backgroundcolor=none]
      \begin{center}
        \begin{tabular}{l l l}
          $\term \Coloneqq $ & & terms: \\
          & $\eunit$ & unit \\
          & $\evar$ & variable \\
          & $\eabs{\anno{\evar}{\type}}{\term}$ & abstraction \\
          & $\eapp{\term}{\term}$ & application \\
          & $\etabs{\anno{\tvar}{\kind}}{\term}$ & type abstraction \\
          & $\etapp{\term}{\type}$ & type application \\
          & $\eprovide{\term}{\evar}{\term}{\term}$ & effect definition \\
          \\
          $\type \Coloneqq$ & & types: \\
          & $\tvar$ & type variable \\
          & $\twitht{\type}{\type}$ & type with effects \\
          & $\tunit$ & unit type \\
          & $\tarrow{\type}{\type}$ & arrow type \\
          & $\tforall{\anno{\tvar}{\kind}}{\type}$ & quantified type \\
          & $\rempty$ & empty effect row \\
          & $\rsingleton{\effect}$ & singleton effect row \\
          & $\runion{\type}{\type}$ & effect row union \\
          \\
          $\kind \Coloneqq$ & & kinds: \\
          & $\kpt$ & kind of a proper type \\
          & $\krow$ & kind of an effect row \\
          & $\ktwitht$ & kind of a proper type with effects \\
          \\
          $\context \Coloneqq$ & & contexts: \\
          & $\cempty$ & empty context \\
          & $\cextend{\context}{\anno{\evar}{\type}}$ & term variable binding \\
          & $\cextend{\context}{\anno{\tvar}{\kind}}$ & type variable binding \\
          \\
          $\effectmap \Coloneqq$ & & effect map: \\
          & $\emempty$ & empty effect map \\
          & $\emextend{\effectmap}{\emmap{\effect}{\anno{\evar}{\type}}}$ & effect binding \\
        \end{tabular}
      \end{center}

      \caption{Syntax}\label{fig:syntax}
    \end{mdframed}
  \end{figure}

  \begin{figure}
    \begin{mdframed}[backgroundcolor=none]
      \begin{center}
        \framebox{$\tjudgment{\context}{\term}{\type}$}
      \end{center}

      \medskip

      \begin{prooftree}
          \AxiomC{}
        \RightLabel{(\textsc{T-Unit})}
        \UnaryInfC{$\tjudgment{\context}{\eunit}{\twitht{\tunit}{\rempty}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\lookup{\context}{\evar} = \type$}
        \RightLabel{(\textsc{T-Variable})}
        \UnaryInfC{$\tjudgment{\context}{\evar}{\type}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\tjudgment{\context}{\type_1}{\ktwitht}$}
          \AxiomC{$\tjudgment{\cextend{\context}{\anno{\evar}{\type_1}}}{\term}{\type_2}$}
        \RightLabel{(\textsc{T-Abstraction})}
        \BinaryInfC{$\tjudgment{\context}{\parens{\eabs{\anno{\evar}{\type_1}}{\term}}}{\twitht{\parens{\tarrow{\type_1}{\type_2}}}}{\rempty}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{\Shortstack[c]{{$\tjudgment{\context}{\term_1}{\type_1}$}
            {$\tjudgment{\context}{\term_2}{\twitht{\parens{\tarrow{\type_2}{\twitht{\type_3}{\type_4}}}}{\type_5}}$}
            {$\subtype{\context}{\type_1}{\type_2}$}}}
        \RightLabel{(\textsc{T-Application})}
        \UnaryInfC{$\tjudgment{\context}{\eapp{\term_2}{\term_1}}{\twitht{\type_3}{\runion{\type_4}{\type_5}}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\tjudgment{\cextend{\context}{\anno{\tvar}{\kind}}}{\term}{\type}$}
        \RightLabel{(\textsc{T-TypeAbstraction})}
        \UnaryInfC{$\tjudgment{\context}{\parens{\etabs{\anno{\tvar}{\kind}}{\term}}}{\twitht{\parens{\tforall{\anno{\tvar}{\kind}}{\type}}}}{\rempty}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\tjudgment{\context}{\term}{\twitht{\parens{\tforall{\anno{\tvar}{\kind}}{\type_1}}}}{\rempty}$}
          \AxiomC{$\tjudgment{\context}{\type_2}{\kind}$}
        \RightLabel{(\textsc{T-TypeApplication})}
        \BinaryInfC{$\tjudgment{\context}{\etapp{\term}{\type_2}}{\sub{\type_1}{\tvar}{\type_2}}$}
      \end{prooftree}

      \caption{Typing rules}\label{fig:typing_rules}
    \end{mdframed}
  \end{figure}

  \begin{figure}
    \begin{mdframed}[backgroundcolor=none]
      \begin{center}
        \framebox{$\opwellformed{\context}{\type}{\evar}$}
      \end{center}

      \medskip

      \begin{prooftree}
          \AxiomC{$\opwellformed{\context}{\type_2}{\evar}$}
          \AxiomC{$\tjudgment{\context}{\type_1}{\ktwitht}$}
          \AxiomC{$\tjudgment{\context}{\type_2}{\ktwitht}$}
          \AxiomC{$\tjudgment{\context}{\type_3}{\krow}$}
        \RightLabel{(\textsc{WF-Arrow})}
        \QuaternaryInfC{$\opwellformed{\context}{\twitht{\parens{\tarrow{\type_1}{\type_2}}}{\type_3}}{\evar}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\opwellformed{\context}{\type_1}{\evar}$}
          \AxiomC{$\tjudgment{\context}{\type_1}{\ktwitht}$}
          \AxiomC{$\tjudgment{\context}{\type_2}{\krow}$}
        \RightLabel{(\textsc{WF-ForAll})}
        \TrinaryInfC{$\opwellformed{\context}{\twitht{\parens{\tforall{\anno{\tvar}{\kind}}{\type_1}}}{\type_2}}{\evar}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\subtype{\context}{\rsingleton{\evar}}{\type_2}$}
          \AxiomC{$\tjudgment{\context}{\type_1}{\ktwitht}$}
          \AxiomC{$\tjudgment{\context}{\type_2}{\krow}$}
        \RightLabel{(\textsc{WF-PureTypeWithEffects})}
        \TrinaryInfC{$\opwellformed{\context}{\twitht{\type_1}{\type_2}}{\evar}$}
      \end{prooftree}

      \caption{Operation type well-formedness}\label{fig:operation_type_well_formedness}
    \end{mdframed}
  \end{figure}

  \begin{figure}
    \begin{mdframed}[backgroundcolor=none]
      \begin{center}
        \framebox{$\subtype{\context}{\type}{\type}$}
      \end{center}

      \medskip

      \begin{prooftree}
          \AxiomC{}
        \RightLabel{(\textsc{ST-Reflexivity})}
        \UnaryInfC{$\subtype{\context}{\type}{\type}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\subtype{\context}{\type_1}{\type_2}$}
          \AxiomC{$\subtype{\context}{\type_2}{\type_3}$}
        \RightLabel{(\textsc{ST-Transitivity})}
        \BinaryInfC{$\subtype{\context}{\type_1}{\type_3}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\subtype{\context}{\type_1}{\type_3}$}
          \AxiomC{$\subtype{\context}{\type_2}{\type_4}$}
        \RightLabel{(\textsc{ST-TypeWithEffects})}
        \BinaryInfC{$\subtype{\context}{\twitht{\type_1}{\type_2}}{\twitht{\type_3}{\type_4}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\subtype{\context}{\type_3}{\type_1}$}
          \AxiomC{$\subtype{\context}{\type_2}{\type_4}$}
        \RightLabel{(\textsc{ST-Arrow})}
        \BinaryInfC{$\subtype{\context}{\tarrow{\type_1}{\type_2}}{\tarrow{\type_3}{\type_4}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\subtype{\context}{\type_1}{\type_2}$}
        \RightLabel{(\textsc{ST-ForAll})}
        \UnaryInfC{$\subtype{\context}{\tforall{\anno{\tvar}{\kind}}{\type_1}}{\tforall{\anno{\tvar}{\kind}}{\type_2}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{}
        \RightLabel{(\textsc{ST-Empty})}
        \UnaryInfC{$\subtype{\context}{\rempty}{\type}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\subtype{\context}{\type_1}{\type_3}$}
          \AxiomC{$\subtype{\context}{\type_2}{\type_3}$}
        \RightLabel{(\textsc{ST-Union})}
        \BinaryInfC{$\subtype{\context}{\runion{\type_1}{\type_2}}{\type_3}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{}
        \RightLabel{(\textsc{ST-WeakeningLeft})}
        \UnaryInfC{$\subtype{\context}{\type_1}{\runion{\type_1}{\type_2}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{}
        \RightLabel{(\textsc{ST-WeakeningRight})}
        \UnaryInfC{$\subtype{\context}{\type_2}{\runion{\type_1}{\type_2}}$}
      \end{prooftree}

      \caption{Subtyping}\label{fig:subtyping}
    \end{mdframed}
  \end{figure}

  \begin{figure}
    \begin{mdframed}[backgroundcolor=none]
      \begin{center}
        \framebox{$\tjudgment{\context}{\type}{\kind}$}
      \end{center}

      \medskip

      \begin{prooftree}
          \AxiomC{$\lookup{\context}{\tvar} = \kind$}
        \RightLabel{(\textsc{K-Variable})}
        \UnaryInfC{$\tjudgment{\context}{\tvar}{\kind}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\tjudgment{\context}{\type_1}{\kpt}$}
          \AxiomC{$\tjudgment{\context}{\type_2}{\krow}$}
        \RightLabel{(\textsc{K-TypeWithEffects})}
        \BinaryInfC{$\tjudgment{\context}{\twitht{\type_1}{\type_2}}{\ktwitht}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{}
        \RightLabel{(\textsc{K-Unit})}
        \UnaryInfC{$\tjudgment{\context}{\tunit}{\kpt}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\tjudgment{\context}{\type_1}{\ktwitht}$}
          \AxiomC{$\tjudgment{\context}{\type_2}{\ktwitht}$}
        \RightLabel{(\textsc{K-Arrow})}
        \BinaryInfC{$\tjudgment{\context}{\tarrow{\type_1}{\type_2}}{\kpt}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\tjudgment{\cextend{\context}{\anno{\tvar}{\kind}}}{\type}{\ktwitht}$}
        \RightLabel{(\textsc{K-ForAll})}
        \UnaryInfC{$\tjudgment{\context}{\tforall{\anno{\tvar}{\kind}}{\type}}{\kpt}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{}
        \RightLabel{(\textsc{K-EmptyRow})}
        \UnaryInfC{$\tjudgment{\context}{\rempty}{\krow}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\lookup{\effectmap}{\effect} = \anno{\evar}{\type}$}
        \RightLabel{(\textsc{K-SingletonRow})}
        \UnaryInfC{$\tjudgment{\context}{\rsingleton{\effect}}{\krow}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\tjudgment{\context}{\type_1}{\krow}$}
          \AxiomC{$\tjudgment{\context}{\type_2}{\krow}$}
        \RightLabel{(\textsc{K-UnionRow})}
        \BinaryInfC{$\tjudgment{\context}{\runion{\type_1}{\type_2}}{\krow}$}
      \end{prooftree}

      \caption{Kinding rules}\label{fig:subsumption}
    \end{mdframed}
  \end{figure}

  \begin{definition}[Effect row membership]
    Let $\type_1 \in \type_2$ where $\tjudgment{\context}{\type_2}{\krow}$ be the smallest relation satisfying
    \begin{enumerate}
      \item $\type \in \rsingleton{\type}$
      \item if $\type_1 \in \type_2$ then $\type_1 \in \runion{\type_2}{\type_3}$, where $\tjudgment{\context}{\type_2}{\krow}$ and $\tjudgment{\context}{\type_3}{\krow}$
      \item if $\type_1 \in \type_3$ then $\type_1 \in \runion{\type_2}{\type_3}$, where $\tjudgment{\context}{\type_2}{\krow}$ and $\tjudgment{\context}{\type_3}{\krow}$
    \end{enumerate}
  \end{definition}

  \begin{theorem}[Effect row subtyping]
    Given any two types $\type_1, \type_2$, where $\tjudgment{\context}{\type_1}{\krow}$ and $\tjudgment{\context}{\type_2}{\krow}$ the following are equivalent:
    \begin{enumerate}
      \item $\subtype{\context}{\type_1}{\type_2}$
      \item $\forall \type \;.\; \type \in \type_1 \implies \type \in \type_2$.
    \end{enumerate}
  \end{theorem}

\end{document}
