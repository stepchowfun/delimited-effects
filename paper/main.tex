%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Document settings and packages %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\documentclass[12pt]{article}

\usepackage[T1]{fontenc} % The font encoding
\usepackage[framemethod=tikz]{mdframed} % For figures (`tikz` allows us to have a transparent background)
\usepackage[margin=1in]{geometry} % For setting the margin
\usepackage{amssymb} % For \varnothing
\usepackage{bussproofs} % For inference rules
\usepackage{float} % For the [H] option in \begin{figure}[H]. NOTE: Stop using this when we have more content
\usepackage{inconsolata} % Monospace font
\usepackage{listings} % For source code
\usepackage{mathtools} % For \Coloneqq
\usepackage{stackengine} % For stacking axioms
\usepackage{stmaryrd} % For \llbracket and \rrbracket
\usepackage{xcolor}

% Add a "Draft" watermark to the background.
\usepackage{draftwatermark}
\SetWatermarkText{\textsc{Draft}}
\SetWatermarkScale{3}
\SetWatermarkLightness{0.975}

\title{Delimited effects}
\date{}

%%%%%%%%%%%%%%%%%%%%%%%%%%
% Source code formatting %
%%%%%%%%%%%%%%%%%%%%%%%%%%

\definecolor{purple}{RGB}{127, 0, 181}

\lstdefinelanguage{gram}{morekeywords={effect, provide}}

\lstset{
  aboveskip=\bigskipamount,
  basicstyle=\ttfamily,
  belowskip=\bigskipamount,
  keepspaces=true,
  keywordstyle=\bfseries\color{purple},
  language=gram,
}

%%%%%%%%%%
% Macros %
%%%%%%%%%%

% Theorem styles
\newtheorem{definition}{Definition}
\newtheorem{theorem}{Theorem}

% Misc
\newcommand\anno[2]{#1 : #2}
\newcommand\apply[2]{#1\parens{#2}}
\newcommand\parens[1]{\left( #1 \right)}
\newcommand\substitute[3]{#1 \left[ #2 \mapsto #3 \right]}

% Terms
\newcommand\term{t}
\newcommand\eunit{()}
\newcommand\evar{x}
\newcommand\eabs[2]{\lambda #1 \; . \; #2}
\newcommand\eapp[2]{#1 \; #2}
\newcommand\etabs[2]{\lambda #1 \; . \; #2}
\newcommand\etapp[2]{#1 \; #2}
\newcommand\eprovide[3]{\textbf{provide} \; #1 \; \textbf{with} \; #2 \; \textbf{in} \; #3}

% Types
\newcommand\tembellished[2]{{#1}^{\textcolor{violet}{#2}}}
\newcommand\type{\tau}
\newcommand\tvar{\alpha}
\newcommand\tunit{1}
\newcommand\tarrow[2]{#1 \rightarrow #2}
\newcommand\tforall[2]{\forall #1 \; . \; #2}

% Rows
\newcommand\row{\varepsilon}
\newcommand\rvar{\nu}
\newcommand\rempty{\varnothing_{\row}}
\newcommand\rsingleton[1]{\left\{ #1 \right\}}
\newcommand\runion[2]{#1 \cup #2}
\newcommand\rdiff[2]{#1 \setminus #2}

% Type contexts
\newcommand\context{\Gamma}
\newcommand\cempty{\varnothing_{\context}}
\newcommand\cextend[2]{#1, #2}

% Effect map
\newcommand\effect{e}
\newcommand\effectmap{E}
\newcommand\emempty{\varnothing_{\effectmap}}
\newcommand\emmap[2]{#1 \mapsto #2}
\newcommand\emextend[2]{#1, #2}

% Judgments
\newcommand\hastype[3]{#1 \vdash \anno{#2}{#3}}
\newcommand\requiv[2]{#1 \; \sim \; #2}
\newcommand\ewellformed[1]{#1 \; \text{well-formed effect}}

%%%%%%%%%%%%%%%%%%%%%
% The specification %
%%%%%%%%%%%%%%%%%%%%%

\begin{document}
  \maketitle

  \begin{abstract}
    We introduce delimited effects, a modest type and effect system capable of modeling a diverse collection of programming language features including algebraic effects, type classes, and dynamic scoping.
  \end{abstract}

  \section{Introduction}

    The system we describe in this paper is motivated by the observation that a variety of seemingly orthogonal ideas in programming languages are variations on a common theme: tracking predicates in the type system without requiring the explicit threading of witnesses through the program at the term level. A sufficiently smart inference algorithm frees the programmer from the ceremony of annotating types and propagating predicates. There's no shortage of examples of this theme: type classes, implicit parameters, algebraic effects, etc. In this paper, we generalize these ideas by a single language construct, which we call \emph{delimited effects}.

    Our primary contributions are:

    \begin{itemize}
      \item We give the syntax, semantics, and typing rules for our system.
      \item We prove that the typing rules are sound with respect to the semantics.
      \item We provide one of many possible type inference algorithms for the system.
      \item We provide several diverse examples of programming language features which are generalized by our system.
    \end{itemize}

    \iffalse
      \begin{lstlisting}[gobble=4]
        effect IO
          getLine   : String ! IO
          printLine : String -> () ! IO
      \end{lstlisting}

      \begin{lstlisting}[gobble=4]
        effect Monoid a
          mempty  : a ! Monoid a
          mappend : a -> a -> a ! Monoid a
      \end{lstlisting}
    \fi

  \section{Overview}

    \subsection{Syntax and semantics}

      \begin{figure}[H]
        \begin{mdframed}[backgroundcolor=none]
          \begin{center}
            \begin{tabular}{l l l}
              $\term \Coloneqq $ & & terms: \\
              & $\eunit$ & unit \\
              & $\evar$ & variable \\
              & $\eabs{\anno{\evar}{\type}}{\term}$ & abstraction \\
              & $\eapp{\term}{\term}$ & application \\
              & $\etabs{\tvar}{\term}$ & type abstraction \\
              & $\etapp{\term}{\type}$ & type application \\
              & $\etabs{\rvar}{\term}$ & row abstraction \\
              & $\etapp{\term}{\row}$ & row application \\
              & $\eprovide{\effect}{\term}{\term}$ & effect definition \\
              \\
              $\type \Coloneqq$ & & types: \\
              & $\tvar$ & type variable \\
              & $\tunit$ & unit type \\
              & $\tarrow{\type}{\tembellished{\type}{\row}}$ & arrow type \\
              & $\tforall{\tvar}{\tembellished{\type}{\row}}$ & type-quantified type \\
              & $\tforall{\rvar}{\tembellished{\type}{\row}}$ & row-quantified type \\
              \\
              $\row \Coloneqq$ & & rows: \\
              & $\rvar$ & row variable \\
              & $\rempty$ & empty row \\
              & $\rsingleton{\effect}$ & singleton row \\
              & $\runion{\row}{\row}$ & row union \\
              & $\rdiff{\row}{\row}$ & row difference \\
              \\
              $\context \Coloneqq$ & & contexts: \\
              & $\cempty$ & empty context \\
              & $\cextend{\context}{\anno{\evar}{\tembellished{\type}{\row}}}$ & variable binding \\
              \\
              $\effectmap \Coloneqq$ & & effect map: \\
              & $\emempty$ & empty effect map \\
              & $\emextend{\effectmap}{\emmap{\effect}{\anno{\evar}{\tembellished{\type}{\row}}}}$ & effect binding \\
            \end{tabular}
          \end{center}

          \caption{Syntax}\label{fig:syntax}
        \end{mdframed}
      \end{figure}

      \begin{figure}[H]
        \begin{mdframed}[backgroundcolor=none]
          \begin{center}
            \framebox{$\hastype{\context}{\term}{\tembellished{\type}{\row}}$}
          \end{center}

          \medskip

          \begin{prooftree}
              \AxiomC{}
            \RightLabel{(\textsc{T-Unit})}
            \UnaryInfC{$\hastype{\context}{\eunit}{\tembellished{\tunit}{\rempty}}$}
          \end{prooftree}

          \begin{prooftree}
              \AxiomC{$\apply{\context}{\evar} = \tembellished{\type}{\row}$}
            \RightLabel{(\textsc{T-Variable})}
            \UnaryInfC{$\hastype{\context}{\evar}{\tembellished{\type}{\row}}$}
          \end{prooftree}

          \begin{prooftree}
              \AxiomC{$\hastype{\cextend{\context}{\anno{\evar}{\tembellished{\type_1}{\rempty}}}}{\term}{\tembellished{\type_2}{\row_2}}$}
            \RightLabel{(\textsc{T-Abstraction})}
            \UnaryInfC{$\hastype{\context}{\parens{\eabs{\anno{\evar}{\type_1}}{\term}}}{\tembellished{\parens{\tarrow{\type_1}{\tembellished{\type_2}{\row_2}}}}{\rempty}}$}
          \end{prooftree}

          \begin{prooftree}
              \AxiomC{$\hastype{\context}{\term_1}{\tembellished{\type_1}{\row_1}}$}
              \AxiomC{$\hastype{\context}{\term_2}{\tembellished{\parens{\tarrow{\type_1}{\tembellished{\type_2}{\row_2}{}}}}{\row_3}}$}
            \RightLabel{(\textsc{T-Application})}
            \BinaryInfC{$\hastype{\context}{\eapp{\term_2}{\term_1}}{\tembellished{\type_2}{\runion{\runion{\row_1}{\row_2}}{\row_3}}}$}
          \end{prooftree}

          \begin{prooftree}
              \AxiomC{$\hastype{\context}{\term}{\tembellished{\type}{\row}}$}
            \RightLabel{(\textsc{T-TypeAbstraction})}
            \UnaryInfC{$\hastype{\context}{\parens{\etabs{\tvar}{\term}}}{\tembellished{\parens{\tforall{\tvar}{\tembellished{\type}{\row}}}}{\rempty}}$}
          \end{prooftree}

          \begin{prooftree}
              \AxiomC{$\hastype{\context}{\term}{\tembellished{\parens{\tforall{\tvar}{\tembellished{\type_2}{\row_1}}}}{\row_2}}$}
            \RightLabel{(\textsc{T-TypeApplication})}
            \UnaryInfC{$\hastype{\context}{\etapp{\term}{\type_1}}{\substitute{\tembellished{\type_2}{\runion{\row_1}{\row_2}}}{\tvar}{\type_1}}$}
          \end{prooftree}

          \begin{prooftree}
              \AxiomC{$\hastype{\context}{\term}{\tembellished{\type}{\row}}$}
            \RightLabel{(\textsc{T-RowAbstraction})}
            \UnaryInfC{$\hastype{\context}{\parens{\etabs{\rvar}{\term}}}{\tembellished{\parens{\tforall{\rvar}{\tembellished{\type}{\row}}}}{\rempty}}$}
          \end{prooftree}

          \begin{prooftree}
              \AxiomC{$\hastype{\context}{\term}{\tembellished{\parens{\tforall{\rvar}{\tembellished{\type}{\row_2}}}}{\row_3}}$}
            \RightLabel{(\textsc{T-RowApplication})}
            \UnaryInfC{$\hastype{\context}{\etapp{\term}{\row_1}}{\substitute{\tembellished{\type}{\runion{\row_2}{\row_3}}}{\rvar}{\row_1}}$}
          \end{prooftree}

          \begin{prooftree}
              \AxiomC{$\apply{\effectmap}{\effect} = \anno{\evar}{\tembellished{\type_1}{\runion{\row_1}{\row_3}}}$}
              \AxiomC{$\hastype{\context}{\term_1}{\tembellished{\type_1}{\row_1}}$}
              \AxiomC{$\hastype{\context}{\term_2}{\tembellished{\type_2}{\row_2}}$}
            \RightLabel{(\textsc{T-Provide})}
            \TrinaryInfC{$\hastype{\context}{\eprovide{\effect}{\term_1}{\term_2}}{\tembellished{\type_2}{\rdiff{\row_2}{\rsingleton{\effect}}}}$}
          \end{prooftree}

          \caption{Typing rules}\label{fig:typing_rules}
        \end{mdframed}
      \end{figure}

      \begin{figure}[H]
        \begin{mdframed}[backgroundcolor=none]
          \begin{center}
            \framebox{$\requiv{\row}{\row}$}
          \end{center}

          \medskip

          \begin{prooftree}
              \AxiomC{}
            \RightLabel{(\textsc{R-Reflexivity})}
            \UnaryInfC{$\requiv{\row}{\row}$}
          \end{prooftree}

          \begin{prooftree}
              \AxiomC{$\requiv{\row_1}{\row_2}$}
            \RightLabel{(\textsc{R-Symmetry})}
            \UnaryInfC{$\requiv{\row_2}{\row_1}$}
          \end{prooftree}

          \begin{prooftree}
              \AxiomC{$\requiv{\row_1}{\row_2}$}
              \AxiomC{$\requiv{\row_2}{\row_3}$}
            \RightLabel{(\textsc{R-Transitivity})}
            \BinaryInfC{$\requiv{\row_1}{\row_3}$}
          \end{prooftree}

          \begin{prooftree}
              \AxiomC{$\requiv{\row_1}{\row_3}$}
              \AxiomC{$\requiv{\row_2}{\row_4}$}
            \RightLabel{(\textsc{R-UnionRewrite})}
            \BinaryInfC{$\requiv{\runion{\row_1}{\row_2}}{\runion{\row_3}{\row_4}}$}
          \end{prooftree}

          \begin{prooftree}
              \AxiomC{$\requiv{\row_1}{\row_3}$}
              \AxiomC{$\requiv{\row_2}{\row_4}$}
            \RightLabel{(\textsc{R-DifferenceRewrite})}
            \BinaryInfC{$\requiv{\rdiff{\row_1}{\row_2}}{\rdiff{\row_3}{\row_4}}$}
          \end{prooftree}

          \begin{prooftree}
              \AxiomC{}
            \RightLabel{(\textsc{R-UnionIdentity})}
            \UnaryInfC{$\requiv{\runion{\row}{\rempty}}{\row}$}
          \end{prooftree}

          \begin{prooftree}
              \AxiomC{}
            \RightLabel{(\textsc{R-DifferenceIdentity})}
            \UnaryInfC{$\requiv{\rdiff{\row}{\rempty}}{\row}$}
          \end{prooftree}

          \begin{prooftree}
              \AxiomC{}
            \RightLabel{(\textsc{R-UnionIdempotency})}
            \UnaryInfC{$\requiv{\runion{\row}{\row}}{\row}$}
          \end{prooftree}

          \begin{prooftree}
              \AxiomC{}
            \RightLabel{(\textsc{R-UnionAssociativity})}
            \UnaryInfC{$\requiv{\runion{\parens{\runion{\row_1}{\row_2}}}{\row_3}}{\runion{\row_1}{\parens{\runion{\row_2}{\row_3}}}}$}
          \end{prooftree}

          \begin{prooftree}
              \AxiomC{}
            \RightLabel{(\textsc{R-UnionCommutativity})}
            \UnaryInfC{$\requiv{\runion{\row_1}{\row_2}}{\runion{\row_2}{\row_1}}$}
          \end{prooftree}

          \begin{prooftree}
              \AxiomC{}
            \RightLabel{(\textsc{R-DifferenceDomination})}
            \UnaryInfC{$\requiv{\rdiff{\row_1}{\parens{\runion{\row_1}{\row_2}}}}{\rempty}$}
          \end{prooftree}

          \begin{prooftree}
              \AxiomC{}
            \RightLabel{(\textsc{R-Distributivity})}
            \UnaryInfC{$\requiv{\rdiff{\parens{\runion{\row_1}{\row_2}}}{\row_3}}{\runion{\parens{\rdiff{\row_1}{\row_3}}}{\parens{\rdiff{\row_2}{\row_3}}}}$}
          \end{prooftree}

          \begin{prooftree}
              \AxiomC{}
            \RightLabel{(\textsc{R-DifferenceCombination})}
            \UnaryInfC{$\requiv{\rdiff{\parens{\rdiff{\row_1}{\row_2}}}{\row_3}}{\rdiff{\row_1}{\parens{\runion{\row_2}{\row_3}}}}$}
          \end{prooftree}

          \caption{Row equivalence}\label{fig:row_equivalence}
        \end{mdframed}
      \end{figure}

      \begin{figure}[H]
        \begin{mdframed}[backgroundcolor=none]
          \begin{center}
            \framebox{$\ewellformed{\emmap{\effect}{\tembellished{\type}{\row}}}$}
          \end{center}

          \medskip

          \begin{prooftree}
              \AxiomC{$\effect \in \row$}
            \RightLabel{(\textsc{WFE-Unit})}
            \UnaryInfC{$\ewellformed{\emmap{\effect}{\tembellished{\tunit}{\row}}}$}
          \end{prooftree}

          \begin{prooftree}
              \AxiomC{$\effect \in \row_2$}
            \RightLabel{(\textsc{WFE-Arrow1})}
            \UnaryInfC{$\ewellformed{\emmap{\effect}{\tembellished{\parens{\tarrow{\type_1}{\tembellished{\type_2}{\row_1}}}}{\row_2}}}$}
          \end{prooftree}

          \begin{prooftree}
              \AxiomC{$\ewellformed{\emmap{\effect}{\tembellished{\type_2}{\row_1}}}$}
            \RightLabel{(\textsc{WFE-Arrow2})}
            \UnaryInfC{$\ewellformed{\emmap{\effect}{\tembellished{\parens{\tarrow{\type_1}{\tembellished{\type_2}{\row_1}}}}{\row_2}}}$}
          \end{prooftree}

          \begin{prooftree}
              \AxiomC{$\effect \in \row_2$}
            \RightLabel{(\textsc{WFE-ForAll1})}
            \UnaryInfC{$\ewellformed{\emmap{\effect}{\tembellished{\parens{\tforall{\tvar}{\tembellished{\type}{\row_1}}}}{\row_2}}}$}
          \end{prooftree}

          \begin{prooftree}
              \AxiomC{$\ewellformed{\emmap{\effect}{\tembellished{\type}{\row_1}}}$}
            \RightLabel{(\textsc{WFE-ForAll2})}
            \UnaryInfC{$\ewellformed{\emmap{\effect}{\tembellished{\parens{\tforall{\tvar}{\tembellished{\type}{\row_1}}}}{\row_2}}}$}
          \end{prooftree}

          \begin{prooftree}
              \AxiomC{$\effect \in \row_2$}
            \RightLabel{(\textsc{WFE-ForAll3})}
            \UnaryInfC{$\ewellformed{\emmap{\effect}{\tembellished{\parens{\tforall{\rvar}{\tembellished{\type}{\row_1}}}}{\row_2}}}$}
          \end{prooftree}

          \begin{prooftree}
              \AxiomC{$\ewellformed{\emmap{\effect}{\tembellished{\type}{\row_1}}}$}
            \RightLabel{(\textsc{WFE-ForAll4})}
            \UnaryInfC{$\ewellformed{\emmap{\effect}{\tembellished{\parens{\tforall{\rvar}{\tembellished{\type}{\row_1}}}}{\row_2}}}$}
          \end{prooftree}

          \caption{Effect well-formedness}\label{fig:effect_well_formedness}
        \end{mdframed}
      \end{figure}

    \subsection{Metatheory}

      \subsubsection{Effect rows}

        \begin{definition}[Effect row membership]
          Let $\effect \in \row$ be the smallest relation satisfying:
          \begin{enumerate}
            \item $\effect \in \rsingleton{\effect}$
            \item $\effect \in \row_1 \implies \effect \in \runion{\row_1}{\row_2}$
            \item $\effect \in \row_2 \implies \effect \in \runion{\row_1}{\row_2}$
            \item $\parens{\effect \in \row_1} \wedge \neg \parens{\effect \in \row_2} \implies \effect \in \rdiff{\row_1}{\row_2}$
          \end{enumerate}
        \end{definition}

        \begin{theorem}[Soundness of effect row equivalence]
          For any $\row_1, \row_2$ not containing any row variables, the following are equivalent:
          \begin{enumerate}
            \item $\requiv{\row_1}{\row_2}$
            \item $\forall \effect \;.\; \effect \in \row_1 \iff \effect \in \row_2$
          \end{enumerate}
        \end{theorem}

\end{document}
