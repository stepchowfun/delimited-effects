%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Document settings and packages %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\documentclass[12pt]{article}

\usepackage[T1]{fontenc} % The font encoding
\usepackage[framemethod=tikz]{mdframed} % For figures (`tikz` allows us to have a transparent background)
\usepackage[margin=1in]{geometry} % For setting the margin
\usepackage{amssymb} % For \varnothing
\usepackage{bussproofs} % For inference rules
\usepackage{float} % For the [H] option in \begin{figure}[H]. NOTE: Stop using this when we have more content
\usepackage{inconsolata} % Monospace font
\usepackage{listings} % For source code
\usepackage{mathtools} % For \Coloneqq
\usepackage{stackengine} % For stacking axioms
\usepackage{stmaryrd} % For \llbracket and \rrbracket
\usepackage{xcolor}

% Add a "Draft" watermark to the background.
\usepackage{draftwatermark}
\SetWatermarkText{\textsc{Draft}}
\SetWatermarkScale{3}
\SetWatermarkLightness{0.975}

\title{Delimited effects}
\date{}

%%%%%%%%%%%%%%%%%%%%%%%%%%
% Source code formatting %
%%%%%%%%%%%%%%%%%%%%%%%%%%

\definecolor{purple}{RGB}{127, 0, 181}

\lstdefinelanguage{gram}{morekeywords={effect, handle}}

\lstset{
  aboveskip=\bigskipamount,
  basicstyle=\ttfamily,
  belowskip=\bigskipamount,
  keepspaces=true,
  keywordstyle=\bfseries\color{purple},
  language=gram,
}

%%%%%%%%%%
% Macros %
%%%%%%%%%%

% Theorem styles
\newtheorem{definition}{Definition}
\newtheorem{theorem}{Theorem}

% Misc
\newcommand\anno[2]{#1 : #2}
\newcommand\apply[2]{#1\parens{#2}}
\newcommand\parens[1]{\left( #1 \right)}
\newcommand\fv[1]{\apply{\text{fv}}{#1}}
\newcommand\substitute[3]{#1 \left[ #3 / #2 \right]}
\makeatletter
\renewcommand{\boxed}[1]{\text{\kern 0.1em\fboxsep=.2em\fbox{\m@th$\displaystyle#1$}\kern 0.1em}}
\makeatother

% Terms
\newcommand\term{t}
\newcommand\eUnit{\texttt{()}}
\newcommand\eVar{x}
\newcommand\eAbs[2]{\lambda #1 \; . \; #2}
\newcommand\eApp[2]{#1 \; #2}
\newcommand\eHandle[3]{\textbf{handle} \; #1 \; \textbf{with} \; #2 \; \textbf{in} \; #3}
\newcommand\eAnno[2]{\anno{#1}{#2}}

% Types
\newcommand\type{\tau}
\newcommand\tUnit{1}
\newcommand\tArrow[4]{\tEmbellished{#1}{#2} \rightarrow \tEmbellished{#3}{#4}}
\newcommand\tEmbellished[2]{{#1}^{\textcolor{violet}{#2}}}

% Rows
\newcommand\row{\varepsilon}
\newcommand\rEmpty{\varnothing}
\newcommand\rSingleton[1]{\left\{ #1 \right\}}
\newcommand\rUnion[2]{#1 \cup #2}

% Variable sets
\newcommand\varSet{\Delta}
\newcommand\vsSingleton[1]{\left\{ #1 \right\}}
\newcommand\vsEmpty{\varnothing}
\newcommand\vsUnion[2]{#1 \cup #2}

% Type contexts
\newcommand\context{\Gamma}
\newcommand\cEmpty{\varnothing}
\newcommand\cExtend[4]{#1, \anno{#2}{\tEmbellished{#3}{#4}}}

% Effect map
\newcommand\effect{e}
\newcommand\effectMap{\Sigma}
\newcommand\emMap[2]{#1 \mapsto #2}
\newcommand\emEmpty{\varnothing}
\newcommand\emExtend[3]{#1, \emMap{#2}{#3}}

% Judgments
\newcommand\subrowSym{\subseteq}
\newcommand\nSubrowSym{\nsubseteq}
\newcommand\subrow[2]{#1 \subrowSym #2}
\newcommand\nSubrow[2]{#1 \nSubrowSym #2}
\newcommand\checkType[7]{#1; #2 \vdash #3 \Downarrow \tEmbellished{#4}{#5} \; | \; #6 ; #7}
\newcommand\inferType[7]{#1; #2 \vdash #3 \Uparrow \tEmbellished{#4}{#5} \; | \; #6 ; #7}
\newcommand\wellFormed[2]{#1; #2 \; \text{well-formed}}

%%%%%%%%%%%%%%%%%%%%%
% The specification %
%%%%%%%%%%%%%%%%%%%%%

\begin{document}
  \maketitle

  \begin{abstract}
    We introduce delimited effects, a modest type and effect system capable of modeling a diverse collection of programming language features including algebraic effects, type classes, and dynamic scoping.
  \end{abstract}

  \section{Introduction}

    \iffalse
      \begin{lstlisting}[gobble=4]
        effect IO
          getLine   : String ! IO
          printLine : String -> () ! IO
      \end{lstlisting}

      \begin{lstlisting}[gobble=4]
        effect Monoid a
          mempty  : a ! Monoid a
          mappend : a -> a -> a ! Monoid a
      \end{lstlisting}
    \fi

  \section{Overview}

    \subsection{Syntax}

      \begin{figure}[H]
        \begin{mdframed}[backgroundcolor=none]
          \begin{center}
            \begin{tabular}{l l l}
              $\term \Coloneqq$ & & terms: \\
              & $\eUnit$ & unit \\
              & $\eVar$ & variable \\
              & $\eAbs{\eVar}{\term}$ & abstraction \\
              & $\eApp{\term}{\term}$ & application \\
              & $\eHandle{\effect}{\term}{\term}$ & effect handler \\
              & $\eAnno{\term}{\type}$ & type annotation \\
              \\
              $\type \Coloneqq$ & & types: \\
              & $\tUnit$ & unit type \\
              & $\tArrow{\type}{\row}{\type}{\row}$ & arrow type \\
              \\
              $\row \Coloneqq$ & & rows: \\
              & $\rEmpty$ & empty row \\
              & $\rSingleton{\effect}$ & singleton row \\
              & $\rUnion{\row}{\row}$ & row union \\
              \\
              $\varSet \Coloneqq$ & & variable sets: \\
              & $\vsEmpty$ & empty variable set \\
              & $\vsSingleton{\eVar}$ & singleton variable set \\
              & $\vsUnion{\varSet}{\varSet}$ & variable set union \\
              \\
              $\context \Coloneqq$ & & contexts: \\
              & $\cEmpty$ & empty context \\
              & $\cExtend{\context}{\eVar}{\type}{\row}$ & variable binding \\
              \\
              $\effectMap \Coloneqq$ & & effect maps: \\
              & $\emEmpty$ & empty effect map \\
              & $\emExtend{\effectMap}{\effect}{\eVar}$ & effect binding \\
            \end{tabular}
          \end{center}

          \caption{Syntax}\label{fig:syntax}
        \end{mdframed}
      \end{figure}

    \subsection{Typing}

      \begin{figure}[H]
        \begin{mdframed}[backgroundcolor=none]
          \begin{center}
            \framebox{
              $\checkType{\context}{\effectMap}{\term}{\type}{\row}{\row}{\varSet}$
              \qquad
              $\inferType{\context}{\effectMap}{\term}{\type}{\row}{\row}{\varSet}$
            }
          \end{center}

          \medskip

          \begin{prooftree}
              \AxiomC{}
            \RightLabel{(\textsc{T-Unit})}
            \UnaryInfC{$\inferType{\context}{\effectMap}{\eUnit}{\tUnit}{\row}{\rEmpty}{\vsEmpty}$}
          \end{prooftree}

          \begin{prooftree}
              \AxiomC{$\tEmbellished{\type}{\row_2} = \apply{\context}{\eVar}$}
              \AxiomC{$
                \parens{\row_3, \varSet} =
                  \begin{cases}
                    \parens{\rEmpty, \vsEmpty} & \text{if } \subrow{\row_2}{\row_1} \\
                    \parens{\row_2, \vsSingleton{\eVar}} & \text{if } \nSubrow{\row_2}{\row_1}
                  \end{cases}
              $}
            \RightLabel{(\textsc{T-Var})}
            \BinaryInfC{$\inferType{\context}{\effectMap}{\eVar}{\type}{\row_1}{\row_3}{\varSet}$}
          \end{prooftree}

          \begin{prooftree}
              \AxiomC{\Shortstack[c]{
                {$\checkType{\cExtend{\context}{\eVar}{\type_2}{\row_2}}{\effectMap}{\term}{\type_1}{\row_1}{\row_4}{\varSet_1}$}
                {$\eVar \notin \varSet_1$}
                {$
                  \parens{\row_5, \varSet_2} =
                    \begin{cases}
                      \parens{\rEmpty, \vsEmpty} & \text{if } \subrow{\row_4}{\row_3} \\
                      \parens{\row_4, \varSet_1} & \text{if } \nSubrow{\row_4}{\row_3}
                    \end{cases}
                $}
              }}
            \RightLabel{(\textsc{T-Abs})}
            \UnaryInfC{$\checkType{\context}{\effectMap}{\parens{\eAbs{\eVar}{\term}}}{\parens{\tArrow{\type_2}{\row_2}{\type_1}{\row_1}}}{\row_3}{\row_5}{\varSet_2}$}
          \end{prooftree}

          \begin{prooftree}
              \AxiomC{\Shortstack[c]{
                {$\inferType{\context}{\effectMap}{\term_1}{\parens{\tArrow{\type_2}{\row_2}{\type_1}{\row_1}}}{\row_3}{\row_4}{\varSet_1}$}
                {$\checkType{\context}{\effectMap}{\term_2}{\type_2}{\row_2}{\row_5}{\varSet_2}$}
                {$
                  \parens{\row_6, \varSet_3} =
                    \begin{cases}
                      \parens{\row_4, \varSet_1} & \text{if } \subrow{\row_1}{\row_3} \wedge \subrow{\row_5}{\row_3} \\
                      \parens{\rUnion{\row_4}{\row_5}, \vsUnion{\varSet_1}{\varSet_2}} & \text{if } \subrow{\row_1}{\row_3} \wedge \nSubrow{\row_5}{\row_3} \\
                      \parens{\rUnion{\rUnion{\rUnion{\row_1}{\row_3}}{\row_4}}{\row_5}, \fv{\eApp{\term_1}{\term_2}}} & \text{if } \nSubrow{\row_1}{\row_3}
                    \end{cases}
                $}
              }}
            \RightLabel{(\textsc{T-App})}
            \UnaryInfC{$\inferType{\context}{\effectMap}{\eApp{\term_1}{\term_2}}{\type_1}{\row_3}{\row_6}{\varSet_3}$}
          \end{prooftree}

          \caption{Type inference (part 1)}\label{fig:typing_1}
        \end{mdframed}
      \end{figure}

      \begin{figure}[H]
        \begin{mdframed}[backgroundcolor=none]
          \begin{center}
            \framebox{
              $\checkType{\context}{\effectMap}{\term}{\type}{\row}{\row}{\varSet}$
              \qquad
              $\inferType{\context}{\effectMap}{\term}{\type}{\row}{\row}{\varSet}$
            }
          \end{center}

          \medskip

          \begin{prooftree}
              \AxiomC{\Shortstack[c]{
                {$\tEmbellished{\type_2}{\row_2} = \apply{\context}{\apply{\effectMap}{\effect}}$}
                {$\type_3 = \substitute{\type_2}{\rSingleton{\effect}}{\row_1}$}
                {$\row_3 = \substitute{\row_2}{\rSingleton{\effect}}{\row_1}$}
                {$\checkType{\context}{\effectMap}{\term_1}{\type_3}{\row_3}{\row_4}{\varSet_1}$}
                {$\inferType{\context}{\effectMap}{\term_2}{\type_1}{\rUnion{\row_1}{\rSingleton{\effect}}}{\row_5}{\varSet_2}$}
                {$
                  \parens{\row_6, \varSet_3} =
                    \begin{cases}
                      \parens{\rEmpty, \vsEmpty} & \text{if } \subrow{\row_4}{\row_1} \\
                      \parens{\row_4, \varSet_1} & \text{if } \nSubrow{\row_4}{\row_1}
                    \end{cases}
                $}
              }}
            \RightLabel{(\textsc{T-Handle1})}
            \UnaryInfC{$\inferType{\context}{\effectMap}{\eHandle{\effect}{\term_1}{\term_2}}{\type_1}{\row_1}{\rUnion{\row_5}{\row_6}}{\vsUnion{\varSet_2}{\varSet_3}}$}
          \end{prooftree}

          \begin{prooftree}
              \AxiomC{\Shortstack[c]{
                {$\tEmbellished{\type_2}{\row_2} = \apply{\context}{\apply{\effectMap}{\effect}}$}
                {$\type_3 = \substitute{\type_2}{\rSingleton{\effect}}{\row_1}$}
                {$\row_3 = \substitute{\row_2}{\rSingleton{\effect}}{\row_1}$}
                {$\checkType{\context}{\effectMap}{\term_1}{\type_3}{\row_3}{\row_4}{\varSet_1}$}
                {$\checkType{\context}{\effectMap}{\term_2}{\type_1}{\rUnion{\row_1}{\rSingleton{\effect}}}{\row_5}{\varSet_2}$}
                {$
                  \parens{\row_6, \varSet_3} =
                    \begin{cases}
                      \parens{\rEmpty, \vsEmpty} & \text{if } \subrow{\row_4}{\row_1} \\
                      \parens{\row_4, \varSet_1} & \text{if } \nSubrow{\row_4}{\row_1}
                    \end{cases}
                $}
              }}
            \RightLabel{(\textsc{T-Handle2})}
            \UnaryInfC{$\checkType{\context}{\effectMap}{\eHandle{\effect}{\term_1}{\term_2}}{\type_1}{\row_1}{\rUnion{\row_5}{\row_6}}{\vsUnion{\varSet_2}{\varSet_3}}$}
          \end{prooftree}

          \begin{prooftree}
              \AxiomC{$\checkType{\context}{\effectMap}{\term}{\type}{\row_1}{\row_2}{\varSet}$}
            \RightLabel{(\textsc{T-Anno})}
            \UnaryInfC{$\inferType{\context}{\effectMap}{\parens{\eAnno{\term}{\type}}}{\type}{\row_1}{\row_2}{\varSet}$}
          \end{prooftree}

          \begin{prooftree}
              \AxiomC{$\inferType{\context}{\effectMap}{\term}{\type_2}{\row_1}{\row_2}{\varSet}$}
              \AxiomC{$\type_1 = \type_2$}
            \RightLabel{(\textsc{T-Sub})}
            \BinaryInfC{$\checkType{\context}{\effectMap}{\term}{\type_1}{\row_1}{\row_2}{\varSet}$}
          \end{prooftree}

          \caption{Type inference (part 2)}\label{fig:typing_2}
        \end{mdframed}
      \end{figure}

      \begin{figure}[H]
        \begin{mdframed}[backgroundcolor=none]
          \begin{center}
            \framebox{$\wellFormed{\context}{\effectMap}$}
          \end{center}

          \medskip

          \begin{prooftree}
              \AxiomC{}
            \RightLabel{(\textsc{WF-Empty})}
            \UnaryInfC{$\wellFormed{\context}{\emEmpty}$}
          \end{prooftree}

          \begin{prooftree}
              \AxiomC{$\wellFormed{\context}{\effectMap}$}
              \AxiomC{$\apply{\context}{\eVar} = \tEmbellished{\type}{\row}$}
              \AxiomC{$\subrow{\rSingleton{\effect}}{\row}$}
            \RightLabel{(\textsc{WF-Effect1})}
            \TrinaryInfC{$\wellFormed{\context}{\emExtend{\effectMap}{\effect}{\eVar}}$}
          \end{prooftree}

          \begin{prooftree}
              \AxiomC{$\wellFormed{\cExtend{\context}{\eVar}{\type_2}{\row_2}}{\emExtend{\effectMap}{\effect}{\eVar}}$}
              \AxiomC{$\apply{\context}{\eVar} = \tEmbellished{\parens{\tArrow{\type_1}{\row_1}{\type_2}{\row_2}}}{\row_3}$}
            \RightLabel{(\textsc{WF-Effect2})}
            \BinaryInfC{$\wellFormed{\context}{\emExtend{\effectMap}{\effect}{\eVar}}$}
          \end{prooftree}

          \caption{Type and effect context well-formedness}\label{fig:context_well_formedness}
        \end{mdframed}
      \end{figure}

\end{document}
