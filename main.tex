%%%%%%%%%%%%%%%%%%%%%
% Document settings %
%%%%%%%%%%%%%%%%%%%%%

\documentclass[12pt]{article}
\usepackage[margin=1in]{geometry} % Just for setting the margin

\title{Delimited effects}
\date{}

% Add a "Draft" watermark to the background
\usepackage{draftwatermark}
\SetWatermarkText{\textsc{Draft}}
\SetWatermarkScale{3}
\SetWatermarkLightness{0.9}

%%%%%%%%%%%%
% Packages %
%%%%%%%%%%%%

\usepackage[colorlinks]{hyperref}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{bussproofs}
\usepackage{mathtools}
\usepackage[framemethod=tikz]{mdframed} % The `tikz` thing allows us to have a transparent background
\usepackage{stackengine} % For stacking axioms
\usepackage{stmaryrd} % For \llbracket and \rrbracket

%%%%%%%%%%
% Macros %
%%%%%%%%%%

% Misc
\newcommand\anno[2]{#1 : #2} % chktex 26
\newcommand\dom[1]{\text{dom}\parens{#1}}
\newcommand\lstof[1]{\overline{#1}}
\newcommand\parens[1]{\left( #1 \right)} % chktex 37
\newcommand\sub[3]{#1 \left[ #2 \mapsto #3 \right]} % chktex 1

% Terms
\newcommand\eterm{t}
\newcommand\evar{x}
\newcommand\eabs[2]{\lambda #1 \; . \; #2} % chktex 1 chktex 26
\newcommand\eappxr[2]{#1 \; #2}
\newcommand\eappxp[2]{#1 \left\llbracket #2 \right\rrbracket} % chktex 1
\newcommand\esabs[2]{\lambda #1 \; . \; #2} % chktex 1 chktex 26
\newcommand\esapp[2]{#1 \; #2}
\newcommand\eeffect[5]{\textbf{effect} \; #1 \; #2 \; \textbf{with} \; \anno{#3}{#4} \; \textbf{in} \; #5}
\newcommand\eprovide[5]{\textbf{provide} \; #1 \; \textbf{using} \; #2 \; \textbf{with} \; #3 = #4 \; \textbf{in} \; #5}

% Schemes
\newcommand\sscheme{\sigma}
\newcommand\stwithx[2]{#1 \; ! \; #2} % chktex 26
\newcommand\svar{\alpha}
\newcommand\sabs[2]{\lambda #1 \; . \; #2} % chktex 1 chktex 26
\newcommand\sapp[2]{#1 \; #2} % chktex 1 chktex 26

% Types
\newcommand\ttype{\tau}
\newcommand\tarrow[2]{#1 \rightarrow #2} % chktex 1
\newcommand\ttforall[2]{\forall #1 \; . \; #2} % chktex 1 chktk 1 chktex 26

% Effect rows
\newcommand\rrow{\varepsilon}
\newcommand\rempty{\varnothing_{\rrow}}
\newcommand\rsingleton[1]{\left\{ #1 \right\}}
\newcommand\runion[2]{#1, #2}

% Kinds
\newcommand\kkind{\kappa}
\newcommand\ktype{\ast}
\newcommand\keffect[2]{\left\langle\anno{#1}{#2}\right\rangle}
\newcommand\krow{\diamond} % chktex 26
\newcommand\karrow[3]{\parens{\anno{#1}{#2}} \rightarrow #3} % chktex 1

% Type contexts
\newcommand\ccontext{\Gamma}
\newcommand\cempty{\varnothing_{\ccontext}}
\newcommand\cextend[2]{#1, #2}

% Judgements
\newcommand\rorder[2]{#1 \; \sqsubseteq \; #2} % chktex 1
\newcommand\tjudgment[3]{#1 \vdash \anno{#2}{#3}} % chktex 1
\newcommand\xopwellformed[2]{#1 \vdash #2} % chktex 1
\newcommand\xusing[4]{#1 \vdash #3 \Rightarrow_{#2} #4} % chktex 1
\newcommand\sequiv[2]{#1 \equiv #2} % chktex 1

% DEPRECATED
\newcommand\keffectold{\dagger}
\newcommand\dcontext{\Delta}
\newcommand\dempty{\varnothing_{\dcontext}}
\newcommand\dextend[2]{#1, #2}
\newcommand\deffect[4]{#1 \mapsto \exists #2 \; . \; \anno{#3}{#4}} % chktex 1 chktex 26

%%%%%%%%%%%%%%%%%%%%%
% The specification %
%%%%%%%%%%%%%%%%%%%%%

\begin{document}
  \maketitle

  \begin{abstract}
    We introduce delimited effects, a modest type and effect system capable of modeling a diverse collection of programming language features including algebraic effects, type classes, and dynamic scoping.
  \end{abstract}

  \section{Introduction}

  \begin{figure}
    \begin{mdframed}[backgroundcolor=none]
      \begin{center}
        \begin{tabular}{l l l}
          $\eterm \Coloneqq $ & & terms: \\
          & $\evar$ & term variable \\
          & $\eabs{\anno{\evar}{\sscheme}}{\eterm}$ & term abstraction \\
          & $\eappxr{\eterm}{\eterm}$ & effect-realizing application \\
          & $\eappxp{\eterm}{\eterm}$ & effect-preserving application \\
          & $\esabs{\anno{\svar}{\kkind}}{\eterm}$ & scheme abstraction \\
          & $\esapp{\eterm}{\sscheme}$ & scheme application \\
          & $\eeffect{\svar}{\lstof{\anno{\svar}{\kkind}}}{\evar}{\sscheme}{\eterm}$ & effect declaration \\
          & $\eprovide{\sscheme}{\rrow}{\evar}{\eterm}{\eterm}$ & effect definition \\
          \\
          $\sscheme \Coloneqq$ & & schemes: \\
          & $\stwithx{\ttype}{\rrow}$ & type with effects \\
          & $\rrow$ & effect row \\
          & $\svar$ & scheme variable \\
          & $\sabs{\anno{\svar}{\kkind}}{\sscheme}$ & operator abstraction \\
          & $\sapp{\sscheme}{\sscheme}$ & operator application \\
          \\
          $\ttype \Coloneqq$ & & types: \\
          & $\tarrow{\sscheme}{\sscheme}$ & arrow type \\
          & $\ttforall{\anno{\svar}{\kkind}}{\sscheme}$ & quantified type \\
          \\
          $\rrow \Coloneqq$ & & effect rows: \\
          & $\rempty$ & empty effect row \\
          & $\rsingleton{\sscheme}$ & singleton effect row \\
          & $\runion{\rrow}{\rrow}$ & effect row union \\
          \\
          $\kkind \Coloneqq $ & & kinds: \\
          & $\ktype$ & kind of proper types \\
          & $\keffect{\evar}{\sscheme}$ & kind of an effect \\
          & $\krow$ & kind of an effect row \\
          & $\karrow{\svar}{\kkind}{\kkind}$ & kind of operators \\
          \\
          $\ccontext \Coloneqq$ & & contexts: \\
          & $\cempty$ & empty context \\
          & $\cextend{\ccontext}{\anno{\evar}{\sscheme}}$ & term variable binding \\
          & $\cextend{\ccontext}{\anno{\svar}{\kkind}}$ & scheme variable binding \\
        \end{tabular}
      \end{center}

      \caption{Syntax}\label{fig:syntax}
    \end{mdframed}
  \end{figure}

  \begin{figure}
    \begin{mdframed}[backgroundcolor=none]
      \begin{center}
        \framebox{$\rorder{\rrow}{\rrow}$}
      \end{center}

      \medskip

      \begin{prooftree}
          \AxiomC{}
        \RightLabel{(\textsc{E-Reflexivity})}
        \UnaryInfC{$\rorder{\rrow}{\rrow}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\rorder{\rrow_1}{\rrow_2}$}
          \AxiomC{$\rorder{\rrow_2}{\rrow_3}$}
        \RightLabel{(\textsc{E-Transitivity})}
        \BinaryInfC{$\rorder{\rrow_1}{\rrow_3}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{}
        \RightLabel{(\textsc{E-LeftAssociativity})}
        \UnaryInfC{$\rorder{\runion{\parens{\runion{\rrow_1}{\rrow_2}}}{\rrow_3}}{\runion{\rrow_1}{\parens{\runion{\rrow_2}{\rrow_3}}}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{}
        \RightLabel{(\textsc{E-RightAssociativity})}
        \UnaryInfC{$\rorder{\runion{\rrow_1}{\parens{\runion{\rrow_2}{\rrow_3}}}}{\runion{\parens{\runion{\rrow_1}{\rrow_2}}}{\rrow_3}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{}
        \RightLabel{(\textsc{E-LeftIdentity})}
        \UnaryInfC{$\rorder{\runion{\rempty}{\rrow}}{\rrow}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{}
        \RightLabel{(\textsc{E-RightIdentity})}
        \UnaryInfC{$\rorder{\rrow}{\runion{\rempty}{\rrow}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{}
        \RightLabel{(\textsc{E-LeftContraction})}
        \UnaryInfC{$\rorder{\runion{\runion{\rrow}{\rsingleton{\sscheme}}}{\rsingleton{\sscheme}}}{\runion{\rrow}{\rsingleton{\sscheme}}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{}
        \RightLabel{(\textsc{E-RightContraction})}
          \UnaryInfC{$\rorder{\runion{\rrow}{\rsingleton{\sscheme}}}{\runion{\runion{\rrow}{\rsingleton{\sscheme}}}{\rsingleton{\sscheme}}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{}
        \RightLabel{(\textsc{E-Weakening})}
        \UnaryInfC{$\rorder{\rrow}{\runion{\rrow}{\rsingleton{\sscheme}}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{}
        \RightLabel{(\textsc{E-Exchange})}
        \UnaryInfC{$\rorder{\runion{\runion{\runion{\rrow_1}{\rsingleton{\sscheme_1}}}{\rsingleton{\sscheme_2}}}{\rrow_2}}{\runion{\runion{\runion{\rrow_1}{\rsingleton{\sscheme_2}}}{\rsingleton{\sscheme_1}}}{\rrow_2}}$}
      \end{prooftree}

      \caption{Effect row preorder}\label{fig:preorder}
    \end{mdframed}
  \end{figure}

  \begin{figure}
    \begin{mdframed}[backgroundcolor=none]
      \begin{center}
        \framebox{$\xusing{\rrow}{\sscheme}{\sscheme}{\sscheme}$}
      \end{center}

      \medskip

      \begin{prooftree}
          \AxiomC{$\xusing{\rrow_1}{\sscheme_5}{\sscheme_1}{\sscheme_3}$}
          \AxiomC{$\xusing{\rrow_1}{\sscheme_5}{\sscheme_2}{\sscheme_4}$}
          \AxiomC{$\rorder{\runion{\rrow_3}{\rrow_4}}{\sub{\rrow_2}{\sscheme_5}{\rrow_1}}$}
        \RightLabel{(\textsc{C-Arrow})}
        \TrinaryInfC{$\xusing{\rrow_1}{\sscheme_5}{\stwithx{\parens{\tarrow{\sscheme_1}{\sscheme_2}}}{\rrow_2}}{\stwithx{\parens{\tarrow{\sscheme_3}{\sscheme_4}}}{\rrow_3}}$}
      \end{prooftree}

      \caption{Operation type compatibility}\label{fig:operation_type_compatibility}
    \end{mdframed}
  \end{figure}

  \begin{figure}
    \begin{mdframed}[backgroundcolor=none]
      \begin{center}
        \framebox{$\xopwellformed{\sscheme}{\sscheme}$}
      \end{center}

      \medskip

      \begin{prooftree}
          \AxiomC{$\xopwellformed{\sscheme_1}{\sscheme_2}$}
        \RightLabel{(\textsc{WF-Arrow})}
        \UnaryInfC{$\xopwellformed{\sscheme_1}{\stwithx{\parens{\tarrow{\sscheme_3}{\sscheme_2}}}{\rrow}}$}
      \end{prooftree}

      \caption{Operation type well-formedness}\label{fig:operation_type}
    \end{mdframed}
  \end{figure}

  \begin{figure}
    \begin{mdframed}[backgroundcolor=none]
      \begin{center}
        \framebox{$\tjudgment{\ccontext}{\eterm}{\sscheme}$}
      \end{center}

      \medskip

      \begin{prooftree}
          \AxiomC{$\anno{\evar}{\sscheme} \in \ccontext$}
        \RightLabel{(\textsc{T-Variable})}
        \UnaryInfC{$\tjudgment{\ccontext}{\evar}{\sscheme}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\tjudgment{\cextend{\ccontext}{\anno{\evar}{\sscheme_1}}}{\eterm}{\sscheme_2}$}
          \AxiomC{$\tjudgment{\ccontext}{\sscheme_1}{\ktype}$}
          \AxiomC{$\evar \notin \dom{\ccontext}$}
        \RightLabel{(\textsc{T-Abstraction})}
        \TrinaryInfC{$\tjudgment{\ccontext}{\parens{\eabs{\anno{\evar}{\sscheme_1}}{\eterm}}}{\tarrow{\sscheme_1}{\sscheme_2}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\tjudgment{\ccontext}{\eterm_1}{\stwithx{\ttype_1}{\rrow_1}}$}
          \AxiomC{$\tjudgment{\ccontext}{\eterm_2}{\stwithx{\parens{\tarrow{\stwithx{\ttype_1}{\rrow_4}}{\stwithx{\ttype_2}{\rrow_2}}}}{\rrow_3}}$}
        \RightLabel{(\textsc{T-EffectRealizingApplication})}
        \BinaryInfC{$\tjudgment{\ccontext}{\eappxr{\eterm_2}{\eterm_1}}{\stwithx{\ttype_2}{\runion{\runion{\rrow_1}{\rrow_2}}{\rrow_3}}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\tjudgment{\ccontext}{\eterm_1}{\stwithx{\ttype_1}{\rrow_1}}$}
          \AxiomC{$\tjudgment{\ccontext}{\eterm_2}{\stwithx{\parens{\tarrow{\stwithx{\ttype_1}{\rrow_4}}{\stwithx{\ttype_2}{\rrow_2}}}}{\rrow_3}}$}
          \AxiomC{$\rorder{\rrow_1}{\rrow_4}$}
        \RightLabel{(\textsc{T-EffectPreservingApplication})}
        \TrinaryInfC{$\tjudgment{\ccontext}{\eappxp{\eterm_2}{\eterm_1}}{\stwithx{\ttype_2}{\runion{\rrow_2}{\rrow_3}}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\tjudgment{\cextend{\ccontext}{\anno{\svar}{\kkind}}}{\eterm}{\sscheme}$}
          \AxiomC{$\svar \notin \dom{\ccontext}$}
        \RightLabel{(\textsc{T-TypeAbstraction})}
        \BinaryInfC{$\tjudgment{\ccontext}{\parens{\esabs{\anno{\svar}{\kkind}}{\eterm}}}{\ttforall{\anno{\svar}{\kkind}}{\sscheme}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\tjudgment{\ccontext}{\eterm}{\ttforall{\anno{\svar}{\kkind}}{\sscheme_1}}$}
          \AxiomC{$\tjudgment{\ccontext}{\sscheme_2}{\kkind}$}
        \RightLabel{(\textsc{T-TypeApplication})}
        \BinaryInfC{$\tjudgment{\ccontext}{\esapp{\eterm}{\sscheme_2}}{\sub{\sscheme_1}{\svar}{\sscheme_2}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\tjudgment{\cextend{\ccontext}{\anno{\evar}{\ttforall{\lstof{\svar}}{\sscheme_1}}}}{\eterm}{\sscheme_2}$}
          \AxiomC{$\xopwellformed{\sapp{\svar}{\svar}}{\sscheme_1}$}
          \AxiomC{$\svar \notin \dom{\dcontext}$}
          \AxiomC{$\xopwellformed{\sapp{\svar}{\svar}}{\sscheme_1}$}
          \AxiomC{$\svar \notin \sscheme_2$}
        \RightLabel{(\textsc{T-Effect})}
        \QuinaryInfC{$\tjudgment{\ccontext}{\eeffect{\svar}{\svar}{\evar}{\sscheme_1}{\eterm}}{\sscheme_2}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\tjudgment{\ccontext}{\eterm_2}{\stwithx{\ttype}{\rrow_1}}$}
          \AxiomC{$\tjudgment{\ccontext}{\eterm_1}{\sscheme_2}$}
          \AxiomC{$\xusing{\rrow_2}{\sscheme}{\sub{\sscheme_1}{\lstof{\svar}}{\lstof{\sscheme}}}{\sscheme_2}$}
          \AxiomC{$\deffect{\svar}{\lstof{\svar}}{\evar}{\sscheme_1} \in \dcontext$}
        \RightLabel{(\textsc{T-Provide})}
        \QuaternaryInfC{$\tjudgment{\ccontext}{\eprovide{\sscheme}{\rrow_2}{\evar}{\eterm_1}{\eterm_2}}{\stwithx{\ttype}{\runion{\rrow_1 - \sscheme}{\rrow_2}}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\tjudgment{\ccontext}{\eterm}{\sscheme_1}$}
          \AxiomC{$\sequiv{\sscheme_1}{\sscheme_2}$}
          \AxiomC{$\tjudgment{\ccontext}{\sscheme_2}{\ktype}$}
        \RightLabel{(\textsc{T-Equiv})}
        \TrinaryInfC{$\tjudgment{\ccontext}{\eterm}{\sscheme_2}$}
      \end{prooftree}

      \caption{Typing rules}\label{fig:typing_rules}
    \end{mdframed}
  \end{figure}

  \begin{figure}
    \begin{mdframed}[backgroundcolor=none]
      \begin{center}
        \framebox{$\tjudgment{\ccontext}{\sscheme}{\kkind}$}
      \end{center}

      \medskip

      \begin{prooftree}
          \AxiomC{$\tjudgment{\ccontext}{\sscheme_1}{\ktype}$}
          \AxiomC{$\tjudgment{\ccontext}{\sscheme_2}{\ktype}$}
          \AxiomC{$\tjudgment{\ccontext}{\rrow}{\krow}$}
        \RightLabel{(\textsc{K-Arrow})}
        \TrinaryInfC{$\tjudgment{\ccontext}{\stwithx{\parens{\tarrow{\sscheme_1}{\sscheme_2}}}{\rrow}}{\ktype}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\tjudgment{\cextend{\ccontext}{\anno{\svar}{\kkind}}}{\sscheme}{\ktype}$}
          \AxiomC{$\tjudgment{\ccontext}{\rrow}{\krow}$}
        \RightLabel{(\textsc{K-ForAll})}
        \BinaryInfC{$\tjudgment{\ccontext}{\stwithx{\parens{\ttforall{\anno{\svar}{\kkind}}{\sscheme}}}{\rrow}}{\ktype}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{}
        \RightLabel{(\textsc{K-EmptyEffectRow})}
        \UnaryInfC{$\tjudgment{\ccontext}{\rempty}{\krow}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\tjudgment{\ccontext}{\sscheme}{\ktype}$}
        \RightLabel{(\textsc{K-SingletonEffectRow})}
        \UnaryInfC{$\tjudgment{\ccontext}{\rsingleton{\sscheme}}{\krow}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\tjudgment{\ccontext}{\rrow_1}{\krow}$}
          \AxiomC{$\tjudgment{\ccontext}{\rrow_2}{\krow}$}
        \RightLabel{(\textsc{K-EffectRowUnion})}
        \BinaryInfC{$\tjudgment{\ccontext}{\runion{\rrow_1}{\rrow_2}}{\krow}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\anno{\svar}{\kkind} \in \ccontext$}
        \RightLabel{(\textsc{K-Variable})}
        \UnaryInfC{$\tjudgment{\ccontext}{\svar}{\kkind}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\tjudgment{\cextend{\ccontext}{\anno{\svar}{\kkind_1}}}{\sscheme}{\kkind_2}$}
        \RightLabel{(\textsc{K-Abstraction})}
        \UnaryInfC{$\tjudgment{\ccontext}{\parens{\sabs{\anno{\svar}{\kkind_1}}{\sscheme}}}{\karrow{\svar}{\kkind_1}{\kkind_2}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\tjudgment{\ccontext}{\sscheme_1}{\kkind_1}$}
          \AxiomC{$\tjudgment{\ccontext}{\sscheme_2}{\karrow{}{\kkind_1}{\kkind_2}}$}
        \RightLabel{(\textsc{K-Application})}
        \BinaryInfC{$\tjudgment{\ccontext}{\sapp{\sscheme_2}{\sscheme_1}}{\kkind_2}$}
      \end{prooftree}

      \caption{Kinding rules}\label{fig:kinding_rules}
    \end{mdframed}
  \end{figure}
\end{document}
