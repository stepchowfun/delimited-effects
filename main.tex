%%%%%%%%%%%%%%%%%%%%%
% Document settings %
%%%%%%%%%%%%%%%%%%%%%

\documentclass[12pt]{article}
\usepackage[margin=1in]{geometry} % Just for setting the margin

\title{Delimited effects}
\date{}

% Add a "Draft" watermark to the background
\usepackage{draftwatermark}
\SetWatermarkText{\textsc{Draft}}
\SetWatermarkScale{3}
\SetWatermarkLightness{0.9}

%%%%%%%%%%%%
% Packages %
%%%%%%%%%%%%

\usepackage[colorlinks]{hyperref}
\usepackage[framemethod=tikz]{mdframed} % The `tikz` thing allows us to have a transparent background
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{bussproofs}
\usepackage{mathtools}
\usepackage{stackengine} % For stacking axioms
\usepackage{stmaryrd} % For \llbracket and \rrbracket

%%%%%%%%%%
% Macros %
%%%%%%%%%%

% Theorem styles
\newtheorem{definition}{Definition}
\newtheorem{theorem}{Theorem}

% Misc
\newcommand\anno[2]{#1 : #2} % chktex 26
\newcommand\dom[1]{\text{dom}\parens{#1}}
\newcommand\lstof[1]{\overline{#1}}
\newcommand\parens[1]{\left( #1 \right)} % chktex 37
\newcommand\sub[3]{#1 \left[ #2 \mapsto #3 \right]} % chktex 1

% Terms
\newcommand\term{t}
\newcommand\evar{x}
\newcommand\eabs[2]{\lambda #1 \; . \; #2} % chktex 1 chktex 26
\newcommand\eappbv[2]{#1 \left\llbracket #2 \right\rrbracket_{\textsc{V}}} % chktex 1
\newcommand\eappbn[2]{#1 \left\llbracket #2 \right\rrbracket_{\textsc{N}}} % chktex 1
\newcommand\etabs[2]{\lambda #1 \; . \; #2} % chktex 1 chktex 26
\newcommand\etapp[2]{#1 \; #2}
\newcommand\eeffect[3]{\textbf{effect} \; \anno{#1}{#2} \; \textbf{in} \; #3}
\newcommand\eprovide[4]{\textbf{provide} \; #1 \; \textbf{with} \; #2 = #3 \; \textbf{in} \; #4}

% Types
\newcommand\type{\sigma}
\newcommand\tptwithx[2]{#1 \; ! \; #2} % chktex 26
\newcommand\tvar{\alpha}
\newcommand\tabs[2]{\lambda #1 \; . \; #2} % chktex 1 chktex 26
\newcommand\tapp[2]{#1 \; #2} % chktex 1 chktex 26

% Proper types
\newcommand\properType{\tau}
\newcommand\ptarrow[2]{#1 \rightarrow #2} % chktex 1
\newcommand\ptforall[2]{\forall #1 \; . \; #2} % chktex 1 chktex 26

% Effect rows
\newcommand\row{\varepsilon}
\newcommand\rempty{\varnothing_{\row}}
\newcommand\rsingleton[1]{\left\{ #1 \right\}}
\newcommand\runion[2]{#1, #2}
\newcommand\rdiff[2]{#1 \; - \; #2} % chktex 8

% Kinds
\newcommand\kind{\kappa}
\newcommand\ktype{\ast}
\newcommand\krow{\diamond} % chktex 26
\newcommand\keffect[3]{\mu #1 \; . \; \left\langle\anno{#2}{#3}\right\rangle} % chktex 1 chktex 26
\newcommand\karrow[2]{\parens{#1} \rightarrow #2} % chktex 1

% Type contexts
\newcommand\context{\Gamma}
\newcommand\cempty{\varnothing_{\context}}
\newcommand\ceextend[2]{#1, #2}
\newcommand\csextend[2]{#1, #2}

% Judgements
\newcommand\tjudgment[3]{#1 \vdash \anno{#2}{#3}} % chktex 1
\newcommand\opwellformed[2]{#1 \; \triangleright \; #2} % chktex 1
\newcommand\subtype[2]{#1 \; \sqsubseteq \; #2} % chktex 1

%%%%%%%%%%%%%%%%%%%%%
% The specification %
%%%%%%%%%%%%%%%%%%%%%

\begin{document}
  \maketitle

  \begin{abstract}
    We introduce delimited effects, a modest type and effect system capable of modeling a diverse collection of programming language features including algebraic effects, type classes, and dynamic scoping.
  \end{abstract}

  \section{Introduction}

  \begin{figure}
    \begin{mdframed}[backgroundcolor=none]
      \begin{center}
        \begin{tabular}{l l l}
          $\term \Coloneqq $ & & terms: \\
          & $\evar$ & variable \\
          & $\eabs{\anno{\evar}{\type}}{\term}$ & abstraction \\
          & $\eappbv{\term}{\term}$ & application by value \\
          & $\eappbn{\term}{\term}$ & application by name \\
          & $\etabs{\anno{\tvar}{\kind}}{\term}$ & type abstraction \\
          & $\etapp{\term}{\type}$ & type application \\
          & $\eeffect{\tvar}{\kind}{\term}$ & effect declaration \\
          & $\eprovide{\type}{\evar}{\term}{\term}$ & effect definition \\
          \\
          $\type \Coloneqq$ & & types: \\
          & $\tptwithx{\properType}{\row}$ & proper type with effects \\
          & $\row$ & effect row \\
          & $\tvar$ & type variable \\
          & $\tabs{\anno{\tvar}{\kind}}{\type}$ & operator abstraction \\
          & $\tapp{\type}{\type}$ & operator application \\
          \\
          $\properType \Coloneqq$ & & proper types: \\
          & $\ptarrow{\type}{\type}$ & arrow type \\
          & $\ptforall{\anno{\tvar}{\kind}}{\type}$ & quantified type \\
          \\
          $\row \Coloneqq$ & & effect rows: \\
          & $\rempty$ & empty effect row \\
          & $\rsingleton{\type}$ & singleton effect row \\
          & $\runion{\row}{\row}$ & effect row union \\
          \\
          $\kind \Coloneqq $ & & kinds: \\
          & $\ktype$ & kind of proper types with effects \\
          & $\krow$ & kind of effect rows \\
          & $\keffect{\tvar}{\evar}{\type}$ & kind of effects \\
          & $\karrow{\anno{\tvar}{\kind}}{\kind}$ & kind of operators \\
          \\
          $\context \Coloneqq$ & & contexts: \\
          & $\cempty$ & empty context \\
          & $\ceextend{\context}{\anno{\evar}{\type}}$ & term variable binding \\
          & $\csextend{\context}{\anno{\tvar}{\kind}}$ & type variable binding \\
        \end{tabular}
      \end{center}

      \caption{Syntax}\label{fig:syntax}
    \end{mdframed}
  \end{figure}

  \begin{figure}
    \begin{mdframed}[backgroundcolor=none]
      \begin{center}
        \framebox{$\tjudgment{\context}{\term}{\type}$}
      \end{center}

      \medskip

      \begin{prooftree}
          \AxiomC{$\anno{\evar}{\type} \in \context$}
        \RightLabel{(\textsc{T-Variable})}
        \UnaryInfC{$\tjudgment{\context}{\evar}{\type}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\tjudgment{\ceextend{\context}{\anno{\evar}{\type_1}}}{\term}{\type_2}$}
          \AxiomC{$\tjudgment{\context}{\type_1}{\ktype}$}
          \AxiomC{$\evar \notin \dom{\context}$}
        \RightLabel{(\textsc{T-Abstraction})}
        \TrinaryInfC{$\tjudgment{\context}{\parens{\eabs{\anno{\evar}{\type_1}}{\term}}}{\tptwithx{\parens{\ptarrow{\type_1}{\type_2}}}}{\rempty}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{\Shortstack[c]{{$\tjudgment{\context}{\term_1}{\tptwithx{\properType_1}{\row_1}}$}
            {$\tjudgment{\context}{\term_2}{\tptwithx{\parens{\ptarrow{\tptwithx{\properType_2}{\row_2}}{\tptwithx{\properType_3}{\row_3}}}}{\row_4}}$}
            {$\subtype{\tptwithx{\properType_1}{\rempty}}{\tptwithx{\properType_2}{\row_2}}$}}}
        \RightLabel{(\textsc{T-ApplicationByValue})}
        \UnaryInfC{$\tjudgment{\context}{\eappbv{\term_2}{\term_1}}{\tptwithx{\properType_3}{\runion{\runion{\row_1}{\row_3}}{\row_4}}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{\Shortstack[c]{{$\tjudgment{\context}{\term_1}{\tptwithx{\properType_1}{\row_1}}$}
            {$\tjudgment{\context}{\term_2}{\tptwithx{\parens{\ptarrow{\tptwithx{\properType_2}{\row_2}}{\tptwithx{\properType_3}{\row_3}}}}{\row_4}}$}
            {$\subtype{\tptwithx{\properType_1}{\row_1}}{\tptwithx{\properType_2}{\row_2}}$}}}
        \RightLabel{(\textsc{T-ApplicationByName})}
        \UnaryInfC{$\tjudgment{\context}{\eappbn{\term_2}{\term_1}}{\tptwithx{\properType_3}{\runion{\row_3}{\row_4}}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\tjudgment{\csextend{\context}{\anno{\tvar}{\kind}}}{\term}{\type}$}
          \AxiomC{$\tvar \notin \dom{\context}$}
        \RightLabel{(\textsc{T-TypeAbstraction})}
        \BinaryInfC{$\tjudgment{\context}{\parens{\etabs{\anno{\tvar}{\kind}}{\term}}}{\tptwithx{\parens{\ptforall{\anno{\tvar}{\kind}}{\type}}}}{\rempty}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\tjudgment{\context}{\term}{\tptwithx{\parens{\ptforall{\anno{\tvar}{\kind}}{\type_1}}}}{\rempty}$}
          \AxiomC{$\tjudgment{\context}{\type_2}{\kind}$}
        \RightLabel{(\textsc{T-TypeApplication})}
        \BinaryInfC{$\tjudgment{\context}{\etapp{\term}{\type_2}}{\sub{\type_1}{\tvar}{\type_2}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{\Shortstack[c]{{$\opwellformed{\type_1}{\tvar_3}$}
            {$\tjudgment{\csextend{\csextend{\context}{\lstof{\anno{\tvar_2^i}{\kind^i}}}}{\anno{\tvar_3}{\keffect{\tvar_3}{\evar}{\type_1}}}}{\type_1}{\ktype}$}
            {$\tvar_1 \notin \type_2$}
            {$\tvar_1 \notin \dom{\context}$}
            {$\evar \notin \dom{\context}$}
            {$\tjudgment{\ceextend{\csextend{\context}{\anno{\tvar_1}{\karrow{\lstof{\anno{\tvar_2^i}{\kind^i}}}{\keffect{\tvar_3}{\evar}{\type_1}}}}}{\anno{\evar}{\type_1}}}{\term}{\type_2}$}}}
        \RightLabel{(\textsc{T-Effect})}
        \UnaryInfC{$\tjudgment{\context}{\parens{\eeffect{\tvar_1}{\karrow{\lstof{\anno{\tvar_2^i}{\kind^i}}}{\keffect{\tvar_3}{\evar}{\type_1}}}{\term}}}{\type_2}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{\Shortstack[c]{{$\tjudgment{\context}{\term_1}{\type_1}$}
            {$\tjudgment{\context}{\term_2}{\tptwithx{\properType}{\row}}$}
            {$\tjudgment{\context}{\type_2}{\keffect{\tvar}{\evar}{\type_3}}$}
            {$\subtype{\type_1}{\sub{\type_3}{\tvar}{\type_2}}$}}}
        \RightLabel{(\textsc{T-Provide})}
        \UnaryInfC{$\tjudgment{\context}{\parens{\eprovide{\type_2}{\evar}{\term_1}{\term_2}}}{\tptwithx{\properType}\rdiff{\row}{\rsingleton{\type_2}}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\tjudgment{\context}{\term}{\type_1}$}
          \AxiomC{$\subtype{\type_1}{\type_2}$}
        \RightLabel{(\textsc{T-Subsumption})}
        \BinaryInfC{$\tjudgment{\context}{\term}{\type_2}$}
      \end{prooftree}

      \caption{Typing rules}\label{fig:typing_rules}
    \end{mdframed}
  \end{figure}

  \begin{figure}
    \begin{mdframed}[backgroundcolor=none]
      \begin{center}
        \framebox{$\tjudgment{\context}{\type}{\kind}$}
      \end{center}

      \medskip

      \begin{prooftree}
          \AxiomC{$\tjudgment{\context}{\type_1}{\ktype}$}
          \AxiomC{$\tjudgment{\context}{\type_2}{\ktype}$}
          \AxiomC{$\tjudgment{\context}{\row}{\krow}$}
        \RightLabel{(\textsc{K-Arrow})}
        \TrinaryInfC{$\tjudgment{\context}{\tptwithx{\parens{\ptarrow{\type_1}{\type_2}}}{\row}}{\ktype}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\tjudgment{\csextend{\context}{\anno{\tvar}{\kind}}}{\type}{\ktype}$}
          \AxiomC{$\tjudgment{\context}{\row}{\krow}$}
        \RightLabel{(\textsc{K-ForAll})}
        \BinaryInfC{$\tjudgment{\context}{\tptwithx{\parens{\ptforall{\anno{\tvar}{\kind}}{\type}}}{\row}}{\ktype}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{}
        \RightLabel{(\textsc{K-EmptyEffectRow})}
        \UnaryInfC{$\tjudgment{\context}{\rempty}{\krow}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\tjudgment{\context}{\type_1}{\keffect{\tvar}{\evar}{\type_2}}$}
        \RightLabel{(\textsc{K-SingletonEffectRow})}
        \UnaryInfC{$\tjudgment{\context}{\rsingleton{\type_1}}{\krow}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\tjudgment{\context}{\row_1}{\krow}$}
          \AxiomC{$\tjudgment{\context}{\row_2}{\krow}$}
        \RightLabel{(\textsc{K-EffectRowUnion})}
        \BinaryInfC{$\tjudgment{\context}{\runion{\row_1}{\row_2}}{\krow}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\anno{\tvar}{\kind} \in \context$}
        \RightLabel{(\textsc{K-Variable})}
        \UnaryInfC{$\tjudgment{\context}{\tvar}{\kind}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\tjudgment{\csextend{\context}{\anno{\tvar}{\kind_1}}}{\type}{\kind_2}$}
        \RightLabel{(\textsc{K-Abstraction})}
        \UnaryInfC{$\tjudgment{\context}{\parens{\tabs{\anno{\tvar}{\kind_1}}{\type}}}{\karrow{\anno{\tvar}{\kind_1}}{\kind_2}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\tjudgment{\context}{\type_1}{\kind_1}$}
          \AxiomC{$\tjudgment{\context}{\type_2}{\karrow{\anno{\tvar}{\kind_1}}{\kind_2}}$}
        \RightLabel{(\textsc{K-Application})}
        \BinaryInfC{$\tjudgment{\context}{\tapp{\type_2}{\type_1}}{\sub{\kind_2}{\tvar}{\type_1}}$}
      \end{prooftree}

      \caption{Kinding rules}\label{fig:kinding_rules}
    \end{mdframed}
  \end{figure}

  \begin{figure}
    \begin{mdframed}[backgroundcolor=none]
      \begin{center}
        \framebox{$\opwellformed{\type}{\tvar}$}
      \end{center}

      \medskip

      \begin{prooftree}
          \AxiomC{$\opwellformed{\type_2}{\tvar}$}
        \RightLabel{(\textsc{WF-Arrow})}
        \UnaryInfC{$\opwellformed{\tptwithx{\parens{\ptarrow{\type_1}{\type_2}}}{\row}}{\tvar}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\opwellformed{\type}{\tvar_2}$}
          \AxiomC{$\tvar_1 \neq \tvar_2$}
        \RightLabel{(\textsc{WF-ForAll})}
        \BinaryInfC{$\opwellformed{\tptwithx{\parens{\ptforall{\anno{\tvar_1}{\kind}}{\type}}}{\row}}{\tvar_2}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\subtype{\rsingleton{\tvar}}{\row}$}
        \RightLabel{(\textsc{WF-TypeWithEffects})}
        \UnaryInfC{$\opwellformed{\tptwithx{\properType}{\row}}{\tvar}$}
      \end{prooftree}

      \caption{Operation type well-formedness}\label{fig:operation_type_well_formedness}
    \end{mdframed}
  \end{figure}

  \begin{figure}
    \begin{mdframed}[backgroundcolor=none]
      \begin{center}
        \framebox{$\subtype{\type}{\type}$}
      \end{center}

      \medskip

      \begin{prooftree}
          \AxiomC{}
        \RightLabel{(\textsc{ST-Reflexivity})}
        \UnaryInfC{$\subtype{\type}{\type}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\subtype{\type_1}{\type_2}$}
          \AxiomC{$\subtype{\type_2}{\type_3}$}
        \RightLabel{(\textsc{ST-Transitivity})}
        \BinaryInfC{$\subtype{\type_1}{\type_3}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\subtype{\type_3}{\type_1}$}
          \AxiomC{$\subtype{\type_2}{\type_4}$}
          \AxiomC{$\subtype{\row_1}{\row_2}$}
        \RightLabel{(\textsc{ST-Arrow})}
        \TrinaryInfC{$\subtype{\tptwithx{\parens{\ptarrow{\type_1}{\type_2}}}{\row_1}}{\tptwithx{\parens{\ptarrow{\type_3}{\type_4}}}{\row_2}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\subtype{\type_1}{\type_2}$}
          \AxiomC{$\subtype{\row_1}{\row_2}$}
        \RightLabel{(\textsc{ST-ForAll})}
        \BinaryInfC{$\subtype{\tptwithx{\parens{\ptforall{\anno{\tvar}{\kind}}{\type_1}}}{\row_1}}{\tptwithx{\parens{\ptforall{\anno{\tvar}{\kind}}{\type_2}}}{\row_2}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{}
        \RightLabel{(\textsc{ST-Empty})}
        \UnaryInfC{$\subtype{\rempty}{\row}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\subtype{\type_1}{\type_2}$}
        \RightLabel{(\textsc{ST-Singleton})}
        \UnaryInfC{$\subtype{\rsingleton{\type_1}}{\rsingleton{\type_2}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\subtype{\row_1}{\row_3}$}
          \AxiomC{$\subtype{\row_2}{\row_3}$}
        \RightLabel{(\textsc{ST-Union})}
        \BinaryInfC{$\subtype{\runion{\row_1}{\row_2}}{\row_3}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{}
        \RightLabel{(\textsc{ST-Weakening})}
        \UnaryInfC{$\subtype{\row_1}{\runion{\row_1}{\row_2}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{}
        \RightLabel{(\textsc{ST-Exchange})}
        \UnaryInfC{$\subtype{\runion{\row_1}{\row_2}}{\runion{\row_2}{\row_1}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\subtype{\type_1}{\type_2}$}
        \RightLabel{(\textsc{ST-TypeAbstraction})}
        \UnaryInfC{$\subtype{\tabs{\anno{\tvar}{\kind}}{\type_1}}{\tabs{\anno{\tvar}{\kind}}{\type_2}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\subtype{\type_1}{\type_2}$}
        \RightLabel{(\textsc{ST-TypeApplication})}
        \UnaryInfC{$\subtype{\tapp{\type_1}{\type_3}}{\tapp{\type_2}{\type_3}}$}
      \end{prooftree}

      \caption{Subtyping}\label{fig:subtyping}
    \end{mdframed}
  \end{figure}

  \begin{definition}[Effect row membership]
    Let $\type \in \row$ be the smallest relation satisfying
    \begin{enumerate}
      \item $\type \in \rsingleton{\type}$
      \item if $\type \in \row_1$ then $\type \in \runion{\row_1}{\row_2}$
      \item if $\type \in \row_2$ then $\type \in \runion{\row_1}{\row_2}$.
    \end{enumerate}
  \end{definition}

  \begin{theorem}[Effect row subtyping]
    Given any two effect rows $\row_1, \row_2$, the following are equivalent:
    \begin{enumerate}
      \item $\subtype{\row_1}{\row_2}$
      \item $\forall \type_1 \;.\; \type_1 \in \row_1 \implies \exists \type_2 \;.\; \subtype{\type_1}{\type_2} \wedge \type_2 \in \row_2$.
    \end{enumerate}
  \end{theorem}

\end{document}
