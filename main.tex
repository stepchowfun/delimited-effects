%%%%%%%%%%%%%%%%%%%%%
% Document settings %
%%%%%%%%%%%%%%%%%%%%%

\documentclass[12pt]{article}
\usepackage[margin=1in]{geometry} % Just for setting the margin

\title{Delimited effects}
\date{}

% Add a "Draft" watermark to the background
\usepackage{draftwatermark}
\SetWatermarkText{\textsc{Draft}}
\SetWatermarkScale{3}
\SetWatermarkLightness{0.9}

%%%%%%%%%%%%
% Packages %
%%%%%%%%%%%%

\usepackage[colorlinks]{hyperref}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{bussproofs}
\usepackage{mathtools}
\usepackage[framemethod=tikz]{mdframed} % The `tikz` thing allows us to have a transparent background
\usepackage{stackengine} % For stacking axioms
\usepackage{stmaryrd} % For \llbracket and \rrbracket

%%%%%%%%%%
% Macros %
%%%%%%%%%%

% Misc
\newcommand\anno[2]{#1 : #2} % chktex 26
\newcommand\dom[1]{\text{dom}\parens{#1}}
\newcommand\lstof[1]{\overline{#1}}
\newcommand\parens[1]{\left( #1 \right)} % chktex 37
\newcommand\sub[3]{#1 \left[ #2 \mapsto #3 \right]} % chktex 1

% Terms
\newcommand\term{t}
\newcommand\evar{x}
\newcommand\eabs[2]{\lambda #1 \; . \; #2} % chktex 1 chktex 26
\newcommand\eappbv[2]{#1 \left\llbracket #2 \right\rrbracket_{\textsc{V}}} % chktex 1
\newcommand\eappbn[2]{#1 \left\llbracket #2 \right\rrbracket_{\textsc{N}}} % chktex 1
\newcommand\esabs[2]{\lambda #1 \; . \; #2} % chktex 1 chktex 26
\newcommand\esapp[2]{#1 \; #2}
\newcommand\eeffect[3]{\textbf{effect} \; \anno{#1}{#2} \; \textbf{in} \; #3}
\newcommand\eprovide[4]{\textbf{provide} \; #1 \; \textbf{with} \; #2 = #3 \; \textbf{in} \; #4}

% Schemes
\newcommand\scheme{\sigma}
\newcommand\stwithx[2]{#1 \; ! \; #2} % chktex 26
\newcommand\svar{\alpha}
\newcommand\sabs[2]{\lambda #1 \; . \; #2} % chktex 1 chktex 26
\newcommand\sapp[2]{#1 \; #2} % chktex 1 chktex 26

% Types
\newcommand\type{\tau}
\newcommand\tarrow[2]{#1 \rightarrow #2} % chktex 1
\newcommand\tforall[2]{\forall #1 \; . \; #2} % chktex 1 chktex 26

% Effect rows
\newcommand\row{\varepsilon}
\newcommand\rempty{\varnothing_{\row}}
\newcommand\rsingleton[1]{\left\{ #1 \right\}}
\newcommand\runion[2]{#1, #2}
\newcommand\rdiff[2]{#1 \; - \; #2} % chktex 8

% Kinds
\newcommand\kind{\kappa}
\newcommand\ktype{\ast}
\newcommand\krow{\diamond} % chktex 26
\newcommand\keffect[3]{\mu #1 \; . \; \left\langle\anno{#2}{#3}\right\rangle} % chktex 1 chktex 26
\newcommand\karrow[2]{\parens{#1} \rightarrow #2} % chktex 1

% Type contexts
\newcommand\context{\Gamma}
\newcommand\cempty{\varnothing_{\context}}
\newcommand\ceextend[2]{#1, #2}
\newcommand\csextend[2]{#1, #2}

% Judgements
\newcommand\tjudgment[3]{#1 \vdash \anno{#2}{#3}} % chktex 1
\newcommand\opwellformed[2]{#1 \; \triangleright \; #2} % chktex 1
\newcommand\subtype[2]{#1 \; \sqsubseteq \; #2} % chktex 1

%%%%%%%%%%%%%%%%%%%%%
% The specification %
%%%%%%%%%%%%%%%%%%%%%

\begin{document}
  \maketitle

  \begin{abstract}
    We introduce delimited effects, a modest type and effect system capable of modeling a diverse collection of programming language features including algebraic effects, type classes, and dynamic scoping.
  \end{abstract}

  \section{Introduction}

  \begin{figure}
    \begin{mdframed}[backgroundcolor=none]
      \begin{center}
        \begin{tabular}{l l l}
          $\term \Coloneqq $ & & terms: \\
          & $\evar$ & variable \\
          & $\eabs{\anno{\evar}{\scheme}}{\term}$ & abstraction \\
          & $\eappbv{\term}{\term}$ & application by value \\
          & $\eappbn{\term}{\term}$ & application by name \\
          & $\esabs{\anno{\svar}{\kind}}{\term}$ & scheme abstraction \\
          & $\esapp{\term}{\scheme}$ & scheme application \\
          & $\eeffect{\svar}{\kind}{\term}$ & effect declaration \\
          & $\eprovide{\scheme}{\evar}{\term}{\term}$ & effect definition \\
          \\
          $\scheme \Coloneqq$ & & schemes: \\
          & $\stwithx{\type}{\row}$ & type with effects \\
          & $\row$ & effect row \\
          & $\svar$ & scheme variable \\
          & $\sabs{\anno{\svar}{\kind}}{\scheme}$ & operator abstraction \\
          & $\sapp{\scheme}{\scheme}$ & operator application \\
          \\
          $\type \Coloneqq$ & & types: \\
          & $\tarrow{\scheme}{\scheme}$ & arrow type \\
          & $\tforall{\anno{\svar}{\kind}}{\scheme}$ & quantified type \\
          \\
          $\row \Coloneqq$ & & effect rows: \\
          & $\rempty$ & empty effect row \\
          & $\rsingleton{\scheme}$ & singleton effect row \\
          & $\runion{\row}{\row}$ & effect row union \\
          \\
          $\kind \Coloneqq $ & & kinds: \\
          & $\ktype$ & kind of proper types \\
          & $\krow$ & kind of effect rows \\
          & $\keffect{\svar}{\evar}{\scheme}$ & kind of effects \\
          & $\karrow{\anno{\svar}{\kind}}{\kind}$ & kind of operators \\
          \\
          $\context \Coloneqq$ & & contexts: \\
          & $\cempty$ & empty context \\
          & $\ceextend{\context}{\anno{\evar}{\scheme}}$ & term variable binding \\
          & $\csextend{\context}{\anno{\svar}{\kind}}$ & scheme variable binding \\
        \end{tabular}
      \end{center}

      \caption{Syntax}\label{fig:syntax}
    \end{mdframed}
  \end{figure}

  \begin{figure}
    \begin{mdframed}[backgroundcolor=none]
      \begin{center}
        \framebox{$\tjudgment{\context}{\term}{\scheme}$}
      \end{center}

      \medskip

      \begin{prooftree}
          \AxiomC{$\anno{\evar}{\scheme} \in \context$}
        \RightLabel{(\textsc{T-Variable})}
        \UnaryInfC{$\tjudgment{\context}{\evar}{\scheme}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\tjudgment{\ceextend{\context}{\anno{\evar}{\scheme_1}}}{\term}{\scheme_2}$}
          \AxiomC{$\tjudgment{\context}{\scheme_1}{\ktype}$}
          \AxiomC{$\evar \notin \dom{\context}$}
        \RightLabel{(\textsc{T-Abstraction})}
        \TrinaryInfC{$\tjudgment{\context}{\parens{\eabs{\anno{\evar}{\scheme_1}}{\term}}}{\tarrow{\scheme_1}{\scheme_2}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{\Shortstack[c]{{$\tjudgment{\context}{\term_1}{\stwithx{\type_1}{\row_1}}$}
            {$\tjudgment{\context}{\term_2}{\stwithx{\parens{\tarrow{\stwithx{\type_2}{\row_2}}{\stwithx{\type_3}{\row_3}}}}{\row_4}}$}
            {$\subtype{\stwithx{\type_1}{\rempty}}{\stwithx{\type_2}{\row_2}}$}}}
        \RightLabel{(\textsc{T-ApplicationByValue})}
        \UnaryInfC{$\tjudgment{\context}{\eappbv{\term_2}{\term_1}}{\stwithx{\type_3}{\runion{\runion{\row_1}{\row_3}}{\row_4}}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{\Shortstack[c]{{$\tjudgment{\context}{\term_1}{\stwithx{\type_1}{\row_1}}$}
            {$\tjudgment{\context}{\term_2}{\stwithx{\parens{\tarrow{\stwithx{\type_2}{\row_2}}{\stwithx{\type_3}{\row_3}}}}{\row_4}}$}
            {$\subtype{\stwithx{\type_1}{\row_1}}{\stwithx{\type_2}{\row_2}}$}}}
        \RightLabel{(\textsc{T-ApplicationByName})}
        \UnaryInfC{$\tjudgment{\context}{\eappbn{\term_2}{\term_1}}{\stwithx{\type_3}{\runion{\row_3}{\row_4}}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\tjudgment{\csextend{\context}{\anno{\svar}{\kind}}}{\term}{\scheme}$}
          \AxiomC{$\svar \notin \dom{\context}$}
        \RightLabel{(\textsc{T-SchemeAbstraction})}
        \BinaryInfC{$\tjudgment{\context}{\parens{\esabs{\anno{\svar}{\kind}}{\term}}}{\tforall{\anno{\svar}{\kind}}{\scheme}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\tjudgment{\context}{\term}{\tforall{\anno{\svar}{\kind}}{\scheme_1}}$}
          \AxiomC{$\tjudgment{\context}{\scheme_2}{\kind}$}
        \RightLabel{(\textsc{T-SchemeApplication})}
        \BinaryInfC{$\tjudgment{\context}{\esapp{\term}{\scheme_2}}{\sub{\scheme_1}{\svar}{\scheme_2}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{\Shortstack[c]{{$\opwellformed{\scheme_1}{\svar_3}$}
            {$\tjudgment{\csextend{\csextend{\context}{\lstof{\anno{\svar_2^i}{\kind^i}}}}{\anno{\svar_3}{\keffect{\svar_3}{\evar}{\scheme_1}}}}{\scheme_1}{\ktype}$}
            {$\svar_1 \notin \scheme_2$}
            {$\svar_1 \notin \dom{\context}$}
            {$\evar \notin \dom{\context}$}
            {$\tjudgment{\ceextend{\csextend{\context}{\anno{\svar_1}{\karrow{\lstof{\anno{\svar_2^i}{\kind^i}}}{\keffect{\svar_3}{\evar}{\scheme_1}}}}}{\anno{\evar}{\scheme_1}}}{\term}{\scheme_2}$}}}
        \RightLabel{(\textsc{T-Effect})}
        \UnaryInfC{$\tjudgment{\context}{\parens{\eeffect{\svar_1}{\karrow{\lstof{\anno{\svar_2^i}{\kind^i}}}{\keffect{\svar_3}{\evar}{\scheme_1}}}{\term}}}{\scheme_2}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{\Shortstack[c]{{$\tjudgment{\context}{\term_1}{\scheme_1}$}
            {$\tjudgment{\context}{\term_2}{\stwithx{\type}{\row}}$}
            {$\tjudgment{\context}{\scheme_2}{\keffect{\svar}{\evar}{\scheme_3}}$}
            {$\subtype{\scheme_1}{\sub{\scheme_3}{\svar}{\keffect{\svar}{\evar}{\scheme_3}}}$}}}
        \RightLabel{(\textsc{T-Provide})}
        \UnaryInfC{$\tjudgment{\context}{\parens{\eprovide{\scheme_2}{\evar}{\term_1}{\term_2}}}{\stwithx{\type}\rdiff{\row}{\rsingleton{\scheme_2}}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\tjudgment{\context}{\term}{\scheme_1}$}
          \AxiomC{$\subtype{\scheme_1}{\scheme_2}$}
        \RightLabel{(\textsc{T-Subsumption})}
        \BinaryInfC{$\tjudgment{\context}{\term}{\scheme_2}$}
      \end{prooftree}

      \caption{Typing rules}\label{fig:typing_rules}
    \end{mdframed}
  \end{figure}

  \begin{figure}
    \begin{mdframed}[backgroundcolor=none]
      \begin{center}
        \framebox{$\tjudgment{\context}{\scheme}{\kind}$}
      \end{center}

      \medskip

      \begin{prooftree}
          \AxiomC{$\tjudgment{\context}{\scheme_1}{\ktype}$}
          \AxiomC{$\tjudgment{\context}{\scheme_2}{\ktype}$}
          \AxiomC{$\tjudgment{\context}{\row}{\krow}$}
        \RightLabel{(\textsc{K-Arrow})}
        \TrinaryInfC{$\tjudgment{\context}{\stwithx{\parens{\tarrow{\scheme_1}{\scheme_2}}}{\row}}{\ktype}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\tjudgment{\csextend{\context}{\anno{\svar}{\kind}}}{\scheme}{\ktype}$}
          \AxiomC{$\tjudgment{\context}{\row}{\krow}$}
        \RightLabel{(\textsc{K-ForAll})}
        \BinaryInfC{$\tjudgment{\context}{\stwithx{\parens{\tforall{\anno{\svar}{\kind}}{\scheme}}}{\row}}{\ktype}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{}
        \RightLabel{(\textsc{K-EmptyEffectRow})}
        \UnaryInfC{$\tjudgment{\context}{\rempty}{\krow}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\tjudgment{\context}{\scheme_1}{\keffect{\svar}{\evar}{\scheme_2}}$}
        \RightLabel{(\textsc{K-SingletonEffectRow})}
        \UnaryInfC{$\tjudgment{\context}{\rsingleton{\scheme_1}}{\krow}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\tjudgment{\context}{\row_1}{\krow}$}
          \AxiomC{$\tjudgment{\context}{\row_2}{\krow}$}
        \RightLabel{(\textsc{K-EffectRowUnion})}
        \BinaryInfC{$\tjudgment{\context}{\runion{\row_1}{\row_2}}{\krow}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\anno{\svar}{\kind} \in \context$}
        \RightLabel{(\textsc{K-Variable})}
        \UnaryInfC{$\tjudgment{\context}{\svar}{\kind}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\tjudgment{\csextend{\context}{\anno{\svar}{\kind_1}}}{\scheme}{\kind_2}$}
        \RightLabel{(\textsc{K-Abstraction})}
        \UnaryInfC{$\tjudgment{\context}{\parens{\sabs{\anno{\svar}{\kind_1}}{\scheme}}}{\karrow{\anno{\svar}{\kind_1}}{\kind_2}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\tjudgment{\context}{\scheme_1}{\kind_1}$}
          \AxiomC{$\tjudgment{\context}{\scheme_2}{\karrow{\anno{\svar}{\kind_1}}{\kind_2}}$}
        \RightLabel{(\textsc{K-Application})}
        \BinaryInfC{$\tjudgment{\context}{\sapp{\scheme_2}{\scheme_1}}{\sub{\kind_2}{\svar}{\scheme_1}}$}
      \end{prooftree}

      \caption{Kinding rules}\label{fig:kinding_rules}
    \end{mdframed}
  \end{figure}

  \begin{figure}
    \begin{mdframed}[backgroundcolor=none]
      \begin{center}
        \framebox{$\opwellformed{\scheme}{\svar}$}
      \end{center}

      \medskip

      \begin{prooftree}
          \AxiomC{$\opwellformed{\scheme_2}{\svar}$}
        \RightLabel{(\textsc{WF-Arrow})}
        \UnaryInfC{$\opwellformed{\stwithx{\parens{\tarrow{\scheme_1}{\scheme_2}}}{\row}}{\svar}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\opwellformed{\scheme}{\svar_2}$}
          \AxiomC{$\svar_1 \neq \svar_2$}
        \RightLabel{(\textsc{WF-ForAll})}
        \BinaryInfC{$\opwellformed{\stwithx{\parens{\tforall{\anno{\svar_1}{\kind}}{\scheme}}}{\row}}{\svar_2}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\subtype{\rsingleton{\svar}}{\row}$}
        \RightLabel{(\textsc{WF-TypeWithEffects})}
        \UnaryInfC{$\opwellformed{\stwithx{\type}{\row}}{\svar}$}
      \end{prooftree}

      \caption{Operation type well-formedness}\label{fig:operation_type_well_formedness}
    \end{mdframed}
  \end{figure}

  \begin{figure}
    \begin{mdframed}[backgroundcolor=none]
      \begin{center}
        \framebox{$\subtype{\scheme}{\scheme}$}
      \end{center}

      \medskip

      \begin{prooftree}
          \AxiomC{}
        \RightLabel{(\textsc{ST-Reflexivity})}
        \UnaryInfC{$\subtype{\scheme}{\scheme}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\subtype{\scheme_1}{\scheme_2}$}
          \AxiomC{$\subtype{\scheme_2}{\scheme_3}$}
        \RightLabel{(\textsc{ST-Transitivity})}
        \BinaryInfC{$\subtype{\scheme_1}{\scheme_3}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\subtype{\scheme_3}{\scheme_1}$}
          \AxiomC{$\subtype{\scheme_2}{\scheme_4}$}
          \AxiomC{$\subtype{\row_1}{\row_2}$}
        \RightLabel{(\textsc{ST-Arrow})}
        \TrinaryInfC{$\subtype{\stwithx{\parens{\tarrow{\scheme_1}{\scheme_2}}}{\row_1}}{\stwithx{\parens{\tarrow{\scheme_3}{\scheme_4}}}{\row_2}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\subtype{\scheme_1}{\scheme_2}$}
          \AxiomC{$\subtype{\row_1}{\row_2}$}
        \RightLabel{(\textsc{ST-ForAll})}
        \BinaryInfC{$\subtype{\stwithx{\parens{\tforall{\anno{\svar}{\kind}}{\scheme_1}}}{\row_1}}{\stwithx{\parens{\tforall{\anno{\svar}{\kind}}{\scheme_2}}}{\row_2}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{}
        \RightLabel{(\textsc{ST-Empty})}
        \UnaryInfC{$\subtype{\rempty}{\row}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\subtype{\scheme_1}{\scheme_2}$}
        \RightLabel{(\textsc{ST-Singleton})}
        \UnaryInfC{$\subtype{\rsingleton{\scheme_1}}{\rsingleton{\scheme_2}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\subtype{\row_1}{\row_3}$}
          \AxiomC{$\subtype{\row_2}{\row_3}$}
        \RightLabel{(\textsc{ST-Union})}
        \BinaryInfC{$\subtype{\runion{\row_1}{\row_2}}{\row_3}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{}
        \RightLabel{(\textsc{ST-Weakening})}
        \UnaryInfC{$\subtype{\row_1}{\runion{\row_1}{\row_2}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{}
        \RightLabel{(\textsc{ST-Exchange})}
        \UnaryInfC{$\subtype{\runion{\row_1}{\row_2}}{\runion{\row_2}{\row_1}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\subtype{\scheme_1}{\scheme_2}$}
        \RightLabel{(\textsc{ST-SchemeAbstraction})}
        \UnaryInfC{$\subtype{\sabs{\anno{\svar}{\kind}}{\scheme_1}}{\sabs{\anno{\svar}{\kind}}{\scheme_2}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\subtype{\scheme_1}{\scheme_2}$}
        \RightLabel{(\textsc{ST-SchemeApplication})}
        \UnaryInfC{$\subtype{\sapp{\scheme_1}{\scheme_3}}{\sapp{\scheme_2}{\scheme_3}}$}
      \end{prooftree}

      \caption{Subtyping}\label{fig:subtyping}
    \end{mdframed}
  \end{figure}
\end{document}
