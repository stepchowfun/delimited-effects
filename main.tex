%%%%%%%%%%%%%%%%%%%%%
% Document settings %
%%%%%%%%%%%%%%%%%%%%%

\documentclass[12pt]{article}
\usepackage[margin=1in]{geometry} % Just for setting the margin

\title{Delimited effects}
\date{}

% Add a "Draft" watermark to the background
\usepackage{draftwatermark}
\SetWatermarkText{\textsc{Draft}}
\SetWatermarkScale{3}
\SetWatermarkLightness{0.9}

%%%%%%%%%%%%
% Packages %
%%%%%%%%%%%%

\usepackage[colorlinks]{hyperref}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{bussproofs}
\usepackage{mathtools}
\usepackage[framemethod=tikz]{mdframed} % The `tikz` thing allows us to have a transparent background
\usepackage{stackengine} % For stacking axioms

%%%%%%%%%%
% Macros %
%%%%%%%%%%

% Misc
\newcommand\parens[1]{\left( #1 \right)} % chktex 37
\newcommand\lstof[1]{\overline{#1}}
\newcommand\lstlen[1]{\text{len}\parens{\lstof{#1}}}

% Terms
\newcommand\eterm{t}
\newcommand\eunit{()}
\newcommand\evar{x}
\newcommand\eabs[2]{\lambda #1 \; . \; #2} % chktex 1 chktex 26
\newcommand\eapp[2]{#1 \; #2}
\newcommand\etabs[2]{\lambda #1 \; . \; #2} % chktex 1 chktex 26
\newcommand\exabs[2]{\lambda #1 \; . \; #2} % chktex 1 chktex 26
\newcommand\etapp[2]{#1 \; #2}
\newcommand\exapp[2]{#1 \; #2}
\newcommand\eeffect[4]{\textbf{effect} \; #1 \; \textbf{with} \; \tanno{#2}{#3} \; \textbf{in} \; #4}
\newcommand\eprovide[5]{\textbf{provide} \; #1 \; \textbf{using} \; #2 \; \textbf{with} \; #3 = #4 \; \textbf{in} \; #5}

% Types
\newcommand\ttype{\tau}
\newcommand\tvar{\alpha}
\newcommand\tunit{1}
\newcommand\tarrow[2]{#1 \rightarrow #2} % chktex 1
\newcommand\ttforall[2]{\forall #1 \; . \; #2} % chktex 1 chktk 1 chktex 26
\newcommand\txforall[2]{\forall #1 \; . \; #2} % chktex 1 chktk 1 chktex 26
\newcommand\tx{\sigma}
\newcommand\twithx[2]{#1 \; ! \; #2} % chktex 26
\newcommand\tanno[2]{#1 : #2} % chktex 26
\newcommand\tsub[3]{#1 \left[ #2 \mapsto #3 \right]} % chktex 1
\newcommand\tjudgment[4]{#1; #2 \vdash \tanno{#3}{#4}} % chktex 1

% Effects
\newcommand\xeffects{E}
\newcommand\xvar{\varepsilon}
\newcommand\xempty{\varnothing_{\xeffects}}
\newcommand\xtapp[2]{#1 \; \lstof{#2}}
\newcommand\xsingleton[1]{\left\{ #1 \right\}}
\newcommand\xunion[2]{#1, #2}
\newcommand\xeffect{e}
\newcommand\xnotint[2]{#1 \notin #2} % chktex 1
\newcommand\xopwellformed[2]{#1 \vdash #2} % chktex 1
\newcommand\xusing[4]{#1 \vdash #3 \Rightarrow_{#2} #4} % chktex 1
\newcommand\xsub[3]{#1 \left[ #2 \mapsto #3 \right]} % chktex 1
\newcommand\xpre[2]{#1 \; \sqsubseteq \; #2} % chktex 1

% Type contexts
\newcommand\ccontext{\Gamma}
\newcommand\cempty{\varnothing_{\ccontext}}
\newcommand\cextend[2]{#1, #2}
\newcommand\cdom[1]{\text{dom}\parens{#1}}

% Effect contexts
\newcommand\dcontext{\Delta}
\newcommand\dempty{\varnothing_{\dcontext}}
\newcommand\dextend[2]{#1, #2}
\newcommand\deffect[4]{#1 \mapsto \exists #2 \; . \; \tanno{#3}{#4}} % chktex 1 chktex 26
\newcommand\ddom[1]{\text{dom}\parens{#1}}

%%%%%%%%%%%%%%%%%%%%%
% The specification %
%%%%%%%%%%%%%%%%%%%%%

\begin{document}
  \maketitle

  \begin{abstract}
    We introduce delimited effects, a modest type and effect system capable of modeling a diverse collection of programming language features including algebraic effects, type classes, and dynamic scoping.
  \end{abstract}

  \section{Introduction}

  \begin{figure}
    \begin{mdframed}[backgroundcolor=none]
      \begin{center}
        \begin{tabular}{l l l}
          $\eterm \Coloneqq $ & & term \\
          & $\eunit$ & unit term \\
          & $\evar$ & term variable \\
          & $\eabs{\tanno{\evar}{\tx}}{\eterm}$ & term abstraction \\
          & $\eapp{\eterm}{\eterm}$ & term application \\
          & $\etabs{\tvar}{\eterm}$ & type abstraction \\
          & $\etapp{\eterm}{\tx}$ & type application \\
          & $\exabs{\xvar}{\eterm}$ & effect row abstraction \\
          & $\exapp{\eterm}{\xeffects}$ & effect row application \\
          & $\eeffect{\xtapp{\xeffect}{\tvar}}{\evar}{\tx}{\eterm}$ & effect declaration \\
          & $\eprovide{\xtapp{\xeffect}{\tx}}{\xeffects}{\evar}{\eterm}{\eterm}$ & effect definition \\
          $\ttype \Coloneqq$ & & type \\
          & $\tvar$ & type variable \\
          & $\tunit$ & unit type \\
          & $\tarrow{\tx}{\tx}$ & arrow type \\
          & $\ttforall{\tvar}{\tx}$ & quantified type \\
          & $\txforall{\xvar}{\tx}$ & quantified effect \\
          $\tx \Coloneqq$ & & type with effects \\
          & $\twithx{\ttype}{\xeffects}$ & effect row bound \\
          $\xeffects \Coloneqq$ & & effect row \\
          & $\xvar$ & effect row variable \\
          & $\xempty$ & empty effect row \\
          & $\xsingleton{\xtapp{\xeffect}{\tx}}$ & singleton effect row \\
          & $\xunion{\xeffects}{\xeffects}$ & effect row union \\
          $\ccontext \Coloneqq$ & & type context \\
          & $\cempty$ & empty type context \\
          & $\cextend{\ccontext}{\tanno{\evar}{\tx}}$ & variable binding \\
          $\dcontext \Coloneqq$ & & effect context \\
          & $\dempty$ & empty effect context \\
          & $\dextend{\dcontext}{\deffect{\xeffect}{\lstof{\tvar}}{\evar}{\tx}}$ & effect binding \\
        \end{tabular}
      \end{center}

      \bigskip

      Let $\lstof{\tvar}$ and $\lstof{\tx}$ denote a list of type variables of length $\lstlen{\tvar}$ and a list of types and effects $\tx$ of length $\lstlen{\tx}$, respectively. Let $\cdom{\ccontext}$ and $\ddom{\dcontext}$ denote the term variables bound by $\ccontext$ and effect row variables bound by $\dcontext$, respectively. Let $\tanno{\evar}{\tx} \in \ccontext$ be the judgment that $\evar$ is bound by $\ccontext$ with type and effects $\tx$. Let $\xnotint{\xeffect}{\tx}$ be the judgment that $\xeffect$ does not appear anywhere in the type or effects of $\tx$. We write $\xnotint{\xeffect}{\ttype}$ as shorthand for $\xnotint{\xeffect}{\twithx{\ttype}{\xempty}}$. Let $\xsub{\xeffects_1}{\xtapp{\xeffect}{\tx}}{\xeffects_2}$ denote the result of substituting $\xeffects_2$ for $\xsingleton{\xtapp{\xeffect}{\tx}}$ in $\xeffects_1$. Let $\tsub{\tx_1}{\tvar}{\tx_2}$ denote the capture-avoiding substitution of $\tx_2$ for $\tvar$ in $\tx_1$.

      \caption{Syntax}\label{fig:syntax}
    \end{mdframed}
  \end{figure}

  \begin{figure}
    \begin{mdframed}[backgroundcolor=none]
      \begin{center}
        \framebox{$\xpre{\xeffects}{\xeffects}$}
      \end{center}

      \medskip

      \begin{prooftree}
          \AxiomC{}
        \RightLabel{(\textsc{\xeffects-Reflexivity})}
        \UnaryInfC{$\xpre{\xeffects}{\xeffects}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\xpre{\xeffects_1}{\xeffects_2}$}
          \AxiomC{$\xpre{\xeffects_2}{\xeffects_3}$}
        \RightLabel{(\textsc{\xeffects-Transitivity})}
        \BinaryInfC{$\xpre{\xeffects_1}{\xeffects_3}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{}
        \RightLabel{(\textsc{\xeffects-LeftAssociativity})}
        \UnaryInfC{$\xpre{\xunion{\parens{\xunion{\xeffects_1}{\xeffects_2}}}{\xeffects_3}}{\xunion{\xeffects_1}{\parens{\xunion{\xeffects_2}{\xeffects_3}}}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{}
        \RightLabel{(\textsc{\xeffects-RightAssociativity})}
        \UnaryInfC{$\xpre{\xunion{\xeffects_1}{\parens{\xunion{\xeffects_2}{\xeffects_3}}}}{\xunion{\parens{\xunion{\xeffects_1}{\xeffects_2}}}{\xeffects_3}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{}
        \RightLabel{(\textsc{\xeffects-LeftIdentity})}
        \UnaryInfC{$\xpre{\xunion{\xempty}{\xeffects}}{\xeffects}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{}
        \RightLabel{(\textsc{\xeffects-RightIdentity})}
        \UnaryInfC{$\xpre{\xeffects}{\xunion{\xempty}{\xeffects}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{}
        \RightLabel{(\textsc{\xeffects-LeftContraction})}
        \UnaryInfC{$\xpre{\xunion{\xunion{\xeffects}{\xsingleton{\xtapp{\xeffect}{\tx}}}}{\xsingleton{\xtapp{\xeffect}{\tx}}}}{\xunion{\xeffects}{\xsingleton{\xtapp{\xeffect}{\tx}}}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{}
        \RightLabel{(\textsc{\xeffects-RightContraction})}
          \UnaryInfC{$\xpre{\xunion{\xeffects}{\xsingleton{\xtapp{\xeffect}{\tx}}}}{\xunion{\xunion{\xeffects}{\xsingleton{\xtapp{\xeffect}{\tx}}}}{\xsingleton{\xtapp{\xeffect}{\tx}}}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{}
        \RightLabel{(\textsc{\xeffects-Weakening})}
        \UnaryInfC{$\xpre{\xeffects}{\xunion{\xeffects}{\xsingleton{\xtapp{\xeffect}{\tx}}}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{}
        \RightLabel{(\textsc{\xeffects-Exchange})}
        \UnaryInfC{$\xpre{\xunion{\xunion{\xunion{\xeffects_1}{\xsingleton{\xtapp{\xeffect_1}{\tx}_1}}}{\xsingleton{\xtapp{\xeffect_2}{\tx}_2}}}{\xeffects_2}}{\xunion{\xunion{\xunion{\xeffects_1}{\xsingleton{\xtapp{\xeffect_2}{\tx}_2}}}{\xsingleton{\xtapp{\xeffect_1}{\tx}_1}}}{\xeffects_2}}$}
      \end{prooftree}

      \caption{Effect row preorder}\label{fig:preorder}
    \end{mdframed}
  \end{figure}

  \begin{figure}
    \begin{mdframed}[backgroundcolor=none]
      \begin{center}
        \framebox{$\xusing{\xeffects}{\xtapp{\xeffect}{\tx}}{\tx}{\tx}$}
      \end{center}

      \medskip

      \begin{prooftree}
          \AxiomC{$\xpre{\xunion{\xeffects_3}{\xeffects_4}}{\xsub{\xeffects_2}{\xtapp{\xeffect}{\tx}}{\xeffects_1}}$}
        \RightLabel{(\textsc{C-Unit})}
        \UnaryInfC{$\xusing{\xeffects_1}{\xtapp{\xeffect}{\tx}}{\twithx{\tunit}{\xeffects_2}}{\twithx{\tunit}{\xeffects_3}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\xusing{\xeffects_1}{\xtapp{\xeffect}{\tx}}{\tx_1}{\tx_3}$}
          \AxiomC{$\xusing{\xeffects_1}{\xtapp{\xeffect}{\tx}}{\tx_2}{\tx_4}$}
          \AxiomC{$\xpre{\xunion{\xeffects_3}{\xeffects_4}}{\xsub{\xeffects_2}{\xtapp{\xeffect}{\tx}}{\xeffects_1}}$}
        \RightLabel{(\textsc{C-Arrow})}
        \TrinaryInfC{$\xusing{\xeffects_1}{\xtapp{\xeffect}{\tx}}{\twithx{\parens{\tarrow{\tx_1}{\tx_2}}}{\xeffects_2}}{\twithx{\parens{\tarrow{\tx_3}{\tx_4}}}{\xeffects_3}}$}
      \end{prooftree}

      \caption{Operation type compatibility}\label{fig:operation_type_compatibility}
    \end{mdframed}
  \end{figure}

  \begin{figure}
    \begin{mdframed}[backgroundcolor=none]
      \begin{center}
        \framebox{$\xopwellformed{\xtapp{\xeffect}{\tvar}}{\tx}$}
      \end{center}

      \medskip

      \begin{prooftree}
          \AxiomC{$\lstlen{\tvar} = \lstlen{\tx}$}
        \RightLabel{(\textsc{WF-Unit})}
        \UnaryInfC{$\xopwellformed{\xtapp{\xeffect}{\tvar}}{\twithx{\tunit}{\xunion{\xeffects}{\xsingleton{\xtapp{\xeffect}{\tx}}}}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\xopwellformed{\xtapp{\xeffect}{\tvar}}{\tx_2}$}
        \RightLabel{(\textsc{WF-Arrow})}
        \UnaryInfC{$\xopwellformed{\xtapp{\xeffect}{\tvar}}{\twithx{\parens{\tarrow{\tx_1}{\tx_2}}}{\xeffects}}$}
      \end{prooftree}

      \caption{Operation type well-formedness}\label{fig:operation_type}
    \end{mdframed}
  \end{figure}

  \begin{figure}
    \begin{mdframed}[backgroundcolor=none]
      \begin{center}
        \framebox{$\tjudgment{\ccontext}{\dcontext}{\eterm}{\tx}$}
      \end{center}

      \medskip

      \begin{prooftree}
          \AxiomC{}
        \RightLabel{(\textsc{T-Unit})}
        \UnaryInfC{$\tjudgment{\ccontext}{\dcontext}{\eunit}{\twithx{\tunit}{\xempty}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\tanno{\evar}{\tx} \in \ccontext$}
        \RightLabel{(\textsc{T-Variable})}
        \UnaryInfC{$\tjudgment{\ccontext}{\dcontext}{\evar}{\tx}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\tjudgment{\cextend{\ccontext}{\tanno{\evar}{\tx_1}}}{\dcontext}{\eterm}{\tx_2}$}
          \AxiomC{$\evar \notin \cdom{\ccontext}$}
        \RightLabel{(\textsc{T-Abstraction})}
        \BinaryInfC{$\tjudgment{\ccontext}{\dcontext}{\eabs{\tanno{\evar}{\tx_1}}{\eterm}}{\tarrow{\tx_1}{\tx_2}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\tjudgment{\ccontext}{\dcontext}{\eterm_1}{\twithx{\ttype_1}{\xeffects_1}}$}
          \AxiomC{$\tjudgment{\ccontext}{\dcontext}{\eterm_2}{\twithx{\parens{\tarrow{\twithx{\ttype_1}{\xeffects_4}}{\twithx{\ttype_2}{\xeffects_2}}}}{\xeffects_3}}$}
          \AxiomC{$\xpre{\xeffects_5}{\xunion{\xeffects_1}{\xunion{\xeffects_2}{\xeffects_3}}}$}
        \RightLabel{(\textsc{T-Application})}
        \TrinaryInfC{$\tjudgment{\ccontext}{\dcontext}{\eapp{\eterm_2}{\eterm_1}}{\twithx{\ttype_2}{\xeffects_5}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\tjudgment{\ccontext}{\dcontext}{\eterm}{\tx}$}
        \RightLabel{(\textsc{T-TypeAbstraction})}
        \UnaryInfC{$\tjudgment{\ccontext}{\dcontext}{\etabs{\tvar}{\eterm}}{\ttforall{\tvar}{\tx}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\tjudgment{\ccontext}{\dcontext}{\eterm}{\ttforall{\tvar}{\tx_1}}$}
        \RightLabel{(\textsc{T-TypeApplication})}
        \UnaryInfC{$\tjudgment{\ccontext}{\dcontext}{\etapp{\eterm}{\tx_2}}{\tsub{\tx_1}{\tvar}{\tx_2}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\tjudgment{\ccontext}{\dcontext}{\eterm}{\tx}$}
        \RightLabel{(\textsc{T-EffectAbstraction})}
        \UnaryInfC{$\tjudgment{\ccontext}{\dcontext}{\exabs{\xvar}{\eterm}}{\txforall{\xvar}{\tx}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\tjudgment{\ccontext}{\dcontext}{\eterm}{\txforall{\xvar}{\tx}}$}
        \RightLabel{(\textsc{T-EffectApplication})}
        \UnaryInfC{$\tjudgment{\ccontext}{\dcontext}{\exapp{\eterm}{\xeffects}}{\xsub{\tx}{\xvar}{\xeffects}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\tjudgment{\ccontext}{\dcontext}{\eterm_2}{\twithx{\ttype}{\xeffects_1}}$}
          \AxiomC{$\tjudgment{\ccontext}{\dcontext}{\eterm_1}{\tx_2}$}
          \AxiomC{$\xusing{\xeffects_2}{\xtapp{\xeffect}{\tx}}{\tsub{\tx_1}{\lstof{\tvar}}{\lstof{\tx}}}{\tx_2}$}
          \AxiomC{$\deffect{\xeffect}{\lstof{\tvar}}{\evar}{\tx_1} \in \dcontext$}
          \AxiomC{$\xnotint{e}{\ttype}$}
        \RightLabel{(\textsc{T-Provide})}
        \QuinaryInfC{$\tjudgment{\ccontext}{\dcontext}{\eprovide{\xtapp{\xeffect}{\tx}}{\xeffects_2}{\evar}{\eterm_1}{\eterm_2}}{\twithx{\ttype}{\xunion{\xeffects_1 - \xtapp{\xeffect}{\tx}}{\xeffects_2}}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\tjudgment{\cextend{\ccontext}{\tanno{\evar}{\ttforall{\lstof{\tvar}}{\tx_1}}}}{\dextend{\dcontext}{\deffect{\xeffect}{\lstof{\tvar}}{\evar}{\tx_1}}}{\eterm}{\tx_2}$}
          \AxiomC{$\xopwellformed{\xtapp{\xeffect}{\tvar}}{\tx_1}$}
          \AxiomC{$\xeffect \notin \ddom{\dcontext}$}
          \AxiomC{$\xopwellformed{\xtapp{\xeffect}{\tvar}}{\tx_1}$}
          \AxiomC{$\xeffect \notin \tx_2$}
        \RightLabel{(\textsc{T-Effect})}
        \QuinaryInfC{$\tjudgment{\ccontext}{\dcontext}{\eeffect{\xtapp{\xeffect}{\tvar}}{\evar}{\tx_1}{\eterm}}{\tx_2}$}
      \end{prooftree}

      \caption{Typing rules}\label{fig:typing_rules}
    \end{mdframed}
  \end{figure}
\end{document}
