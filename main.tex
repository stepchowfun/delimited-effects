%%%%%%%%%%%%%%%%%%%%%
% Document settings %
%%%%%%%%%%%%%%%%%%%%%

\documentclass[12pt]{article}

\title{Delimited effects}
\date{}

% Add a "Draft" watermark to the background
\usepackage{draftwatermark}
\SetWatermarkText{\textsc{Draft}}
\SetWatermarkScale{3}

%%%%%%%%%%%%
% Packages %
%%%%%%%%%%%%

\usepackage[colorlinks]{hyperref}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{bussproofs}
\usepackage{mathtools}
\usepackage{mdframed}
\usepackage{stackengine} % For stacking axioms

%%%%%%%%%%
% Macros %
%%%%%%%%%%

% Misc
\newcommand\parens[1]{\left( #1 \right)} % chktex 37
\newcommand\sub[3]{#1 \left[ #2 \mapsto #3 \right]} % chktex 1

% Terms
\newcommand\eterm{t}
\newcommand\econst{c}
\newcommand\evar{x}
\newcommand\eabs[2]{\lambda #1 \; . \; #2} % chktex 1 chktex 26
\newcommand\eapp[2]{#1 \; #2}
\newcommand\eappx[2]{#1 \; \$ \; #2}
\newcommand\eeffect[4]{\textbf{effect} \; #1 \; \textbf{with} \; \tanno{#2}{#3} \; \textbf{in} \; #4}

% Types
\newcommand\ttype{\tau}
\newcommand\tconst{\kappa}
\newcommand\tvar{\alpha}
\newcommand\tarrow[2]{#1 \rightarrow #2} % chktex 1
\newcommand\tanno[2]{#1 : #2} % chktex 26
\newcommand\tjudgment[3]{#1 \vdash \tanno{#2}{#3}} % chktex 1
\newcommand\tx{\sigma}
\newcommand\twithx[2]{#1 \; ! \; #2} % chktex 26

% Effects
\newcommand\xeffect{e}
\newcommand\xeffects{\Delta}
\newcommand\xempty{\varnothing_{\xeffect}}
\newcommand\xextend[2]{#1, #2}
\newcommand\xunion[2]{#1, #2}
\newcommand\xnotint[2]{#1 \notin #2} % chktex 1

% Contexts
\newcommand\ccontext{\Gamma}
\newcommand\cempty{\varnothing_{\ccontext}}
\newcommand\cextend[2]{#1, #2}
\newcommand\cunion[2]{#1, #2}

%%%%%%%%%%%%%%%%%%%%%
% The specification %
%%%%%%%%%%%%%%%%%%%%%

\begin{document}

  \maketitle

  \begin{figure}
    \begin{mdframed}
      \begin{center}
        \begin{tabular}{l l l}
          $\eterm \Coloneqq $ & & term \\
          & $\econst$ & constant \\
          & $\evar$ & variable \\
          & $\eabs{\tanno{\evar}{\tx}}{\eterm}$ & abstraction \\
          & $\eapp{\eterm}{\eterm}$ & effect-realizing application \\
          & $\eappx{\eterm}{\eterm}$ & effect-preserving application \\
          & $\eeffect{\xeffect}{\evar}{\tx}{\eterm}$ & effect introduction \\
          $\ttype \Coloneqq$ & & type \\
          & $\tconst$ & type of constants \\
          & $\tarrow{\tx}{\tx}$ & arrow type \\
          $\tx \Coloneqq$ & & type with effects \\
          & $\twithx{\xeffects}{\ttype}$ & effect annotation \\
          $\xeffects \Coloneqq$ & & effect set \\
          & $\xempty$ & empty effect \\
          & $\xextend{\xeffects}{\xeffect}$ & effect extension \\
          $\ccontext \Coloneqq$ & & type context \\
          & $\cempty$ & empty type context \\
          & $\cextend{\ccontext}{\tanno{\evar}{\tx}}$ & variable binding \\
        \end{tabular}
      \end{center}

      \bigskip

      Let $\xunion{\xeffects_1}{\xeffects_2}$ denote the concatenation of $\xeffects_1$ and $\xeffects_2$. Formally, let $\xunion{\xeffects}{\xempty} = \xeffects$ and $\xunion{\xeffects_1}{\parens{\xextend{\xeffects_2}{\xeffect}}} = \xextend{\parens{\xunion{\xeffects_1}{\xeffects_2}}}{\xeffect}$. Similarly, let $\cunion{\ccontext_1}{\ccontext_2}$ denote the concatenation of $\ccontext_1$ and $\ccontext_2$. Formally, let $\cunion{\ccontext}{\cempty} = \ccontext$ and $\cunion{\ccontext_1}{\parens{\cextend{\ccontext_2}{\tanno{\evar}{\tx}}}} = \cextend{\parens{\cunion{\ccontext_1}{\ccontext_2}}}{\tanno{\evar}{\tx}}$. Let $\xnotint{\xeffect}{\tx}$ denote the judgment that $\xeffect$ does not appear anywhere in the type or effects of $\tx$.

      \caption{Syntax}\label{fig:syntax}
    \end{mdframed}
  \end{figure}

  \begin{figure}
    \begin{mdframed}
      \begin{center}
        \framebox{$\tjudgment{\ccontext}{\eterm}{\tx}$}
      \end{center}

      \medskip

      \begin{prooftree}
          \AxiomC{}
        \RightLabel{(\textsc{T-Constant})}
        \UnaryInfC{$\tjudgment{\ccontext}{\econst}{\twithx{\xempty}{\tconst}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{}
        \RightLabel{(\textsc{T-Variable})}
        \UnaryInfC{$\tjudgment{\cextend{\ccontext}{\tanno{\evar}{\tx}}}{\evar}{\tx}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\tjudgment{\cextend{\ccontext}{\tanno{\evar}{\tx_1}}}{\eterm}{\tx_2}$}
        \RightLabel{(\textsc{T-Abstraction})}
        \UnaryInfC{$\tjudgment{\ccontext}{\eabs{\tanno{\evar}{\tx_1}}{\eterm}}{\tarrow{\tx_1}{\tx_2}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{\Shortstack[c]{{$\tjudgment{\ccontext}{\eterm_1}{\twithx{\xeffects_1}{\ttype_1}}$}
          {$\tjudgment{\ccontext}{\eterm_2}{\twithx{\xeffects_3}{\parens{\tarrow{\twithx{\xempty}{\ttype_1}}{\twithx{\xeffects_2}{\ttype_2}}}}}$}}}
        \RightLabel{(\textsc{T-Application1})}
        \UnaryInfC{$\tjudgment{\ccontext}{\eapp{\eterm_2}{\eterm_1}}{\twithx{\xunion{\xeffects_1}{\xunion{\xeffects_2}{\xeffects_3}}}{\ttype_2}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{\Shortstack[c]{{$\tjudgment{\ccontext}{\eterm_1}{\tx}$}
          {$\tjudgment{\ccontext}{\eterm_2}{\twithx{\xeffects_1}{\parens{\tarrow{\tx}{\twithx{\xeffects_2}{\ttype_2}}}}}$}}}
        \RightLabel{(\textsc{T-Application2})}
        \UnaryInfC{$\tjudgment{\ccontext}{\eappx{\eterm_2}{\eterm_1}}{\twithx{\xunion{\xeffects_1}{\xeffects_2}}{\ttype_2}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{\Shortstack[c]{{$\ccontext$,} {$\tanno{\evar}{\twithx{\xextend{\xeffects_1}{\xeffect}}{\ttype}}$,} {$\tanno{\xeffect}{\forall \xeffects_2, \xeffects_3, a \;.\; \tarrow{\twithx{\xunion{\xeffects_1}{\xeffects_3}}{\ttype}}{\tarrow{\twithx{\xextend{\xeffects_2}{\xeffect}}{a}}{\twithx{\xunion{\xeffects_2}{\xeffects_3}}{a}}}}$} {$\vdash \tanno{\eterm}{\tx}$} {$\xeffect \notin \tx$}}}
        \RightLabel{(\textsc{T-Effect})}
        \UnaryInfC{$\tjudgment{\ccontext}{\eeffect{\xeffect}{\evar}{\twithx{\xeffects_1}{\ttype}}{\eterm}}{\tx}$}
      \end{prooftree}

      \caption{Typing rules}\label{fig:typing_rules}
    \end{mdframed}
  \end{figure}

  \begin{figure}
    \begin{mdframed}
      \begin{center}
        \framebox{$\tjudgment{\ccontext}{\eterm}{\tx}$}
      \end{center}

      \medskip

      \begin{prooftree}
          \AxiomC{$\tjudgment{\ccontext}{\eterm}{\tx_2}$}
        \RightLabel{(\textsc{$\ccontext$-Weaken})}
        \UnaryInfC{$\tjudgment{\cextend{\ccontext}{\tanno{x}{\tx_1}}}{\eterm}{\tx_2}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\tjudgment{\cunion{\cextend{\cextend{\ccontext_1}{\tanno{x_1}{\tx_1}}}{\tanno{x_2}{\tx_2}}}{\ccontext_2}}{\eterm}{\tx_3}$}
        \RightLabel{(\textsc{$\ccontext$-Exchange})}
        \UnaryInfC{$\tjudgment{\cunion{\cextend{\cextend{\ccontext_1}{\tanno{x_2}{\tx_2}}}{\tanno{x_1}{\tx_1}}}{\ccontext_2}}{\eterm}{\tx_3}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\tjudgment{\ccontext}{\eterm}{\twithx{\xeffects}{\ttype}}$}
        \RightLabel{(\textsc{$\xeffects$-Weaken1})}
        \UnaryInfC{$\tjudgment{\ccontext}{\eterm}{\twithx{\xextend{\xeffects}{\xeffect}}{\ttype}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\tjudgment{\cextend{\ccontext}{\tanno{x}{\twithx{\xextend{\xeffects}{\xeffect}}{\ttype}}}}{\eterm}{\tx}$}
        \RightLabel{(\textsc{$\xeffects$-Weaken2})}
        \UnaryInfC{$\tjudgment{\cextend{\ccontext}{\tanno{x}{\twithx{\xeffects}{\ttype}}}}{\eterm}{\tx}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\tjudgment{\ccontext}{\eterm}{\twithx{\xunion{\xextend{\xextend{\xeffects_1}{\xeffect_1}}{\xeffect_2}}{\xeffects_2}}{\ttype}}$}
        \RightLabel{(\textsc{$\xeffects$-Exchange1})}
        \UnaryInfC{$\tjudgment{\ccontext}{\eterm}{\twithx{\xunion{\xextend{\xextend{\xeffects_1}{\xeffect_2}}{\xeffect_1}}{\xeffects_2}}{\ttype}}$}
      \end{prooftree}

      \begin{prooftree}
          \AxiomC{$\tjudgment{\cextend{\ccontext}{\tanno{x}{\twithx{\xunion{\xextend{\xextend{\xeffects_1}{\xeffect_1}}{\xeffect_2}}{\xeffects_2}}{\ttype}}}}{\eterm}{\tx}$}
        \RightLabel{(\textsc{$\xeffects$-Exchange2})}
        \UnaryInfC{$\tjudgment{\cextend{\ccontext}{\tanno{x}{\twithx{\xunion{\xextend{\xextend{\xeffects_1}{\xeffect_2}}{\xeffect_1}}{\xeffects_2}}{\ttype}}}}{\eterm}{\tx}$}
      \end{prooftree}

      \caption{Structural rules}\label{fig:structural_rules}
    \end{mdframed}
  \end{figure}

\end{document}
